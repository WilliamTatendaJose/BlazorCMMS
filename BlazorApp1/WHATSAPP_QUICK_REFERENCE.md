# WhatsApp Integration - Quick Reference

## ?? For Technicians

### How Authentication Works
1. **Phone Number = Identity**: Your WhatsApp phone number is linked to your CMMS user account
2. **You only see YOUR work orders**: All queries and actions are filtered to show only work assigned to you
3. **No login required**: Just message from your registered phone number

### With AI Assistant (Natural Language)
Just talk naturally! Examples:
- "What work do I have today?"
- "Tell me about my pending work orders"
- "I'm starting work on the pump now"
- "Just replaced the bearing, it was worn"
- "I need to delay - waiting for parts"
- "This needs supervisor help"

### Basic Commands (Always Available)
| Command | What it does |
|---------|--------------|
| `HELP` | Show all commands |
| `MY WORK` | List YOUR work orders |
| `PENDING` | Show YOUR tasks needing action |
| `STATUS` | Quick summary of YOUR workload |

### Work Order Actions
| Command | What it does |
|---------|--------------|
| `ACK` | Acknowledge YOUR latest work order |
| `ACK WO-123` | Acknowledge specific WO (must be assigned to you) |
| `START` | Start YOUR acknowledged work |
| `START WO-123` | Start specific WO (must be assigned to you) |
| `COMPLETE` | Mark YOUR current work as done |
| `COMPLETE WO-123` | Complete specific WO (must be assigned to you) |

### Updates
| Command | What it does |
|---------|--------------|
| `NOTE Fixed bearing` | Add note to YOUR current work |
| `DELAY Waiting parts` | Report delay with reason |
| `ESCALATE` | Request supervisor help |

### Alerts
| Command | What it does |
|---------|--------------|
| `RESPONDING` | Confirm alert response |
| `CONFIRM` | Accept scheduled work |

### ?? Authorization Rules
- You can ONLY view work orders assigned to you
- You can ONLY update/acknowledge/complete YOUR own work orders
- Attempting to access another technician's work order will be denied
- All unauthorized access attempts are logged

---

## ?? For Administrators

### How Technician Authentication Works

```
???????????????????????????????????????????????????????????????????????
?                    WHATSAPP AUTHENTICATION FLOW                      ?
???????????????????????????????????????????????????????????????????????
?                                                                      ?
?  1. Technician sends WhatsApp message                               ?
?     ????????????????                                                ?
?     ? +1234567890  ? ??????? "What's my work for today?"           ?
?     ????????????????                                                ?
?                                                                      ?
?  2. System looks up user by phone number                            ?
?     ????????????????????????????????????????????????????????       ?
?     ? SELECT * FROM AspNetUsers                             ?       ?
?     ? WHERE PhoneNumber = '+1234567890'                     ?       ?
?     ????????????????????????????????????????????????????????       ?
?                                                                      ?
?  3. If found ? User authenticated                                   ?
?     If not found ? "Phone not registered" error                     ?
?                                                                      ?
?  4. All queries filtered by AssignedTo = userName                   ?
?     ????????????????????????????????????????????????????????       ?
?     ? SELECT * FROM WorkOrders                              ?       ?
?     ? WHERE AssignedTo = 'John Smith'  ? Only THEIR work   ?       ?
?     ????????????????????????????????????????????????????????       ?
?                                                                      ?
?  5. All actions verify ownership before executing                   ?
?     ????????????????????????????????????????????????????????       ?
?     ? IF workOrder.AssignedTo != userName                   ?       ?
?     ?   RETURN "Not authorized"                             ?       ?
?     ????????????????????????????????????????????????????????       ?
?                                                                      ?
???????????????????????????????????????????????????????????????????????
```

### Setting Up Technician Phone Numbers

1. **In User Management** (`/rbm/users`):
   - Edit each technician's profile
   - Add their WhatsApp phone number with country code (e.g., `+1234567890`)

2. **Or in AspNetUsers table**:
   ```sql
   UPDATE AspNetUsers 
   SET PhoneNumber = '+1234567890' 
   WHERE UserName = 'John Smith';
   ```

### Authorization Checks

The system enforces these authorization rules:

| Action | Check Performed |
|--------|----------------|
| View work orders | `WHERE AssignedTo = userName` |
| Acknowledge WO | Verify `AssignedTo = userName` |
| Start WO | Verify `AssignedTo = userName` |
| Complete WO | Verify `AssignedTo = userName` |
| Add notes | Verify `AssignedTo = userName` |
| Report delay | Verify `AssignedTo = userName` |
| Escalate | Verify `AssignedTo = userName` |

### Security Logging

All unauthorized access attempts are logged:

```csharp
_logger.LogWarning(
    "Unauthorized access attempt: User {UserName} tried to access work order {WorkOrderId} assigned to {AssignedTo}",
    userName, workOrderId, workOrder.AssignedTo);
```

### Configuration (appsettings.json)
```json
"WhatsApp": {
  "Enabled": true,
  "UseLLM": true,
  "TwilioAccountSid": "ACxxx...",
  "TwilioAuthToken": "xxx...",
  "FromNumber": "+14155238886"
},
"AzureOpenAI": {
  "Enabled": true,
  "Endpoint": "https://YOUR_RESOURCE.openai.azure.com",
  "ApiKey": "YOUR_API_KEY",
  "DeploymentName": "gpt-4o-mini"
}
```

### Webhook URLs
- **Incoming**: `/api/whatsappwebhook/incoming`
- **Status**: `/api/whatsappwebhook/status`
- **Health**: `/api/whatsappwebhook/health`

### Admin UI
Navigate to: `/rbm/whatsapp-settings` (Admin only)

---

## ?? Files
- `Services/WhatsAppService.cs` - Main WhatsApp service with authorization
- `Services/WhatsAppLLMService.cs` - AI Assistant service with authorization
- `Controllers/WhatsAppWebhookController.cs` - API endpoints
- `Models/WhatsAppMessageLog.cs` - Data model
- `Components/Pages/RBM/WhatsAppSettings.razor` - Admin page

## ?? Full Documentation
- `WHATSAPP_INTEGRATION_GUIDE.md` - Setup guide
- `WHATSAPP_AI_ASSISTANT_GUIDE.md` - AI features

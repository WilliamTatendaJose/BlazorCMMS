@page "/rbm/analytics"
@rendermode InteractiveServer
@layout RBMLayout
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject BlazorApp1.Services.DataService DataService
@inject BlazorApp1.Services.CurrentUserService CurrentUser
@inject BlazorApp1.Services.RolePermissionService RolePermissionService
@inject BlazorApp1.Services.ITenantManagementService TenantService
@inject NavigationManager Navigation
@using BlazorApp1.Models
@using BlazorApp1.Components.Shared

@if (!isInitialized)
{
    <div style="text-align: center; padding: 60px;">
        <div style="font-size: 48px; margin-bottom: 16px;">⏳</div>
        <div style="color: var(--rbm-text-light);">Loading analytics data...</div>
    </div>
}
else
{
<div class="rbm-page-header">
    <h1 class="rbm-page-title">Reliability Analytics</h1>
    <p class="rbm-page-subtitle">
        Performance metrics and predictive insights
        @if (!string.IsNullOrEmpty(tenantName))
        {
            <span style="margin-left: 8px; font-size: 12px; color: var(--rbm-accent);">📊 @tenantName</span>
        }
    </p>
</div>

<div class="rbm-action-bar">
    <div>
        @if (isSuperAdmin)
        {
            <span class="rbm-badge-pill" style="background: var(--rbm-accent); color: white;">
                🔓 Viewing All Tenants Data
            </span>
        }
    </div>
    @if (CurrentUser.CanEdit)
    {
        <button class="rbm-btn rbm-btn-primary" @onclick="ExportReport">
            📥 Export Report
        </button>
    }
</div>

<!-- KPIs -->
<div class="rbm-grid rbm-grid-4">
    <div class="rbm-stat-card">
        <div class="rbm-stat-label">Overall MTBF</div>
        <div class="rbm-stat-value">@overallMTBF.ToString("F0")</div>
        <div class="rbm-stat-trend @(mtbfTrend >= 0 ? "positive" : "negative")">@(mtbfTrend >= 0 ? "↑" : "↓") @Math.Abs(mtbfTrend).ToString("F1")% vs last month</div>
    </div>
    <div class="rbm-stat-card">
        <div class="rbm-stat-label">Overall MTTR</div>
        <div class="rbm-stat-value">@overallMTTR.ToString("F1")</div>
        <div class="rbm-stat-trend @(mttrTrend <= 0 ? "positive" : "negative")">@(mttrTrend >= 0 ? "↑" : "↓") @Math.Abs(mttrTrend).ToString("F1")% vs last month</div>
    </div>
    <div class="rbm-stat-card">
        <div class="rbm-stat-label">Equipment Availability</div>
        <div class="rbm-stat-value">@overallAvailability.ToString("F1")%</div>
        <div class="rbm-stat-trend @(availabilityTrend >= 0 ? "positive" : "negative")">@(availabilityTrend >= 0 ? "↑" : "↓") @Math.Abs(availabilityTrend).ToString("F1")% improvement</div>
    </div>
    <div class="rbm-stat-card">
        <div class="rbm-stat-label">Reliability Score</div>
        <div class="rbm-stat-value">@overallReliability.ToString("F1")%</div>
        <div class="rbm-stat-trend @(reliabilityTrend >= 0 ? "positive" : "negative")">@(reliabilityTrend >= 0 ? "↑" : "↓") @Math.Abs(reliabilityTrend).ToString("F1")% improvement</div>
    </div>
</div>

<!-- Trend Charts -->
<div class="rbm-grid rbm-grid-2 mt-3">
    <div class="rbm-card">
        <div class="rbm-card-header">
            <h3 class="rbm-card-title">MTBF Trend (Last 12 Months)</h3>
        </div>
        <div class="rbm-chart">
            <SimpleLineChart Title="Mean Time Between Failures" 
                           Subtitle="Trending upward - reliability improving"
                           DataPoints="@mtbfTrendData"
                           LineColor="#43a047" />
        </div>
    </div>
    
    <div class="rbm-card">
        <div class="rbm-card-header">
            <h3 class="rbm-card-title">MTTR Trend (Last 12 Months)</h3>
        </div>
        <div class="rbm-chart">
            <SimpleLineChart Title="Mean Time To Repair (Hours)" 
                           Subtitle="Minor increase - review maintenance procedures"
                           DataPoints="@mttrTrendData"
                           LineColor="#fb8c00" />
        </div>
    </div>
</div>

<!-- Pareto Analysis -->
<div class="rbm-card mt-3">
    <div class="rbm-card-header">
        <h3 class="rbm-card-title">Pareto Analysis - Top Failure Causes</h3>
        <p class="rbm-card-subtitle">80/20 rule: Focus on top causes for maximum impact</p>
    </div>
    <div class="rbm-table-container">
        <table class="rbm-table">
            <thead>
                <tr>
                    <th>Failure Cause</th>
                    <th>Occurrences</th>
                    <th>Percentage</th>
                    <th>Cumulative %</th>
                    <th>Impact</th>
                </tr>
            </thead>
            <tbody>
                @if (paretoData.Any())
                {
                    @foreach (var item in paretoData)
                    {
                        <tr>
                            <td><strong>@item.Cause</strong></td>
                            <td>@item.Occurrences</td>
                            <td>@item.Percentage.ToString("F0")%</td>
                            <td>@item.Cumulative.ToString("F0")%</td>
                            <td><span class="rbm-badge-pill @item.ImpactClass">@item.ImpactLevel</span></td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" style="text-align: center; color: var(--rbm-text-light);">No failure data available</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Predictive Maintenance Recommendations -->
<div class="rbm-card mt-3">
    <div class="rbm-card-header">
        <h3 class="rbm-card-title">🤖 AI-Powered Predictive Maintenance Recommendations</h3>
    </div>
    <div style="padding: 20px;">
        @if (predictiveRecommendations.Any())
        {
            @foreach (var rec in predictiveRecommendations)
            {
                <div style="padding: 16px; background: @rec.BackgroundColor; border-left: 4px solid @rec.BorderColor; border-radius: 8px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong style="color: @rec.TextColor;">@rec.Icon @rec.AssetName - @rec.RiskLevel</strong>
                            <p style="margin: 8px 0 0 0;">@rec.MainMessage</p>
                            <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--rbm-text-light);">
                                @rec.SubMessage
                            </p>
                        </div>
                        @if (CurrentUser.CanEdit && rec.ActionType == "CreateWO")
                        {
                            <button class="rbm-btn rbm-btn-danger rbm-btn-sm" @onclick="() => CreateWorkOrderForAsset(rec.AssetId, true)">Create WO</button>
                        }
                        else if (CurrentUser.CanEdit && rec.ActionType == "Schedule")
                        {
                            <button class="rbm-btn rbm-btn-warning rbm-btn-sm" @onclick="() => CreateScheduleForAsset(rec.AssetId)">Schedule</button>
                        }
                        else
                        {
                            <button class="rbm-btn rbm-btn-outline rbm-btn-sm" @onclick="() => ViewAssetDetails(rec.AssetId)">View Details</button>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <div style="padding: 16px; background: rgba(67, 160, 71, 0.1); border-left: 4px solid var(--rbm-success); border-radius: 8px;">
                <strong style="color: var(--rbm-success);">✅ All equipment is operating within normal parameters</strong>
                <p style="margin: 8px 0 0 0;">No immediate maintenance recommendations at this time.</p>
            </div>
        }
    </div>
</div>

<!-- Equipment Performance by Location -->
<div class="rbm-card mt-3">
    <div class="rbm-card-header">
        <h3 class="rbm-card-title">Equipment Availability by Location</h3>
    </div>
    <div class="rbm-table-container">
        <table class="rbm-table">
            <thead>
                <tr>
                    <th>Location</th>
                    <th>Total Assets</th>
                    <th>Availability %</th>
                    <th>Avg Health Score</th>
                    <th>Open Work Orders</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var location in GetLocationStats())
                {
                    <tr>
                        <td><strong>@location.Name</strong></td>
                        <td>@location.AssetCount</td>
                        <td>
                            <span style="color: @(location.Availability >= 95 ? "var(--rbm-success)" : location.Availability >= 90 ? "var(--rbm-warning)" : "var(--rbm-danger)");">
                                @location.Availability.ToString("F1")%
                            </span>
                        </td>
                        <td>@location.AvgHealth.ToString("F1")</td>
                        <td>@location.OpenWorkOrders</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
}

@if (showSuccessMessage)
{
    <div style="position: fixed; top: 80px; right: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; border-left: 4px solid var(--rbm-success);">
        <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 24px;">✓</span>
            <div>
                <div style="font-weight: 600; color: var(--rbm-success);">Success!</div>
                <div style="font-size: 14px; color: var(--rbm-text-light);">@successMessage</div>
            </div>
        </div>
    </div>
}

@code {
    private List<Asset> assets = new();
    private List<WorkOrder> workOrders = new();
    private List<FailureMode> failureModes = new();
    private List<ReliabilityMetric> reliabilityMetrics = new();
    private bool showSuccessMessage = false;
    private string successMessage = "";
    private bool isInitialized = false;
    
    // Tenant context
    private bool isSuperAdmin = false;
    private int? currentTenantId = null;
    private string tenantName = "";
    
    private List<SimpleLineChart.ChartDataPoint> mtbfTrendData = new();
    private List<SimpleLineChart.ChartDataPoint> mttrTrendData = new();
    
    // KPI values
    private double overallMTBF = 0;
    private double overallMTTR = 0;
    private double overallAvailability = 0;
    private double overallReliability = 0;
    
    // Trend percentages
    private double mtbfTrend = 0;
    private double mttrTrend = 0;
    private double availabilityTrend = 0;
    private double reliabilityTrend = 0;
    
    // Pareto data
    private List<ParetoItem> paretoData = new();
    
    // Predictive recommendations
    private List<PredictiveRecommendation> predictiveRecommendations = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get tenant context first
            isSuperAdmin = await RolePermissionService.IsSuperAdminAsync();
            currentTenantId = await RolePermissionService.GetCurrentTenantIdAsync();
            
            // Get tenant name for display
            if (currentTenantId.HasValue && !isSuperAdmin)
            {
                var tenant = await TenantService.GetTenantByIdAsync(currentTenantId.Value);
                tenantName = tenant?.Name ?? "";
            }
            
            // All DataService methods already filter by tenant internally
            assets = await DataService.GetAssetsAsync();
            workOrders = await DataService.GetWorkOrdersAsync();
            failureModes = await DataService.GetFailureModesAsync();
            
            // Get reliability metrics for tenant-filtered assets
            reliabilityMetrics = new List<ReliabilityMetric>();
            foreach (var asset in assets.Take(20)) // Limit to avoid performance issues
            {
                try
                {
                    var assetMetrics = await DataService.GetReliabilityMetricsAsync(asset.Id);
                    reliabilityMetrics.AddRange(assetMetrics);
                }
                catch { /* Skip assets that fail */ }
            }
            
            CalculateKPIs();
            GenerateTrendData();
            GenerateParetoData();
            GeneratePredictiveRecommendations();
            
            isInitialized = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading analytics data: {ex.Message}");
            isInitialized = true;
        }
    }
    
    private void CalculateKPIs()
    {
        // Calculate MTBF (Mean Time Between Failures) from actual failure work orders
        var failureWorkOrders = workOrders
            .Where(wo => wo.Type == "Corrective" || wo.Type == "Emergency")
            .Where(wo => wo.CreatedDate >= DateTime.Now.AddMonths(-12))
            .OrderBy(wo => wo.CreatedDate)
            .ToList();
        
        if (failureWorkOrders.Count > 1 && assets.Any())
        {
            // Calculate time between failures
            var timeBetweenFailures = new List<double>();
            for (int i = 1; i < failureWorkOrders.Count; i++)
            {
                var hoursBetween = (failureWorkOrders[i].CreatedDate - failureWorkOrders[i-1].CreatedDate).TotalHours;
                timeBetweenFailures.Add(hoursBetween);
            }
            overallMTBF = timeBetweenFailures.Any() ? timeBetweenFailures.Average() : 0;
        }
        else if (reliabilityMetrics.Any())
        {
            // Use reliability metrics if available
            var mtbfValues = reliabilityMetrics.Where(r => r.MTBF > 0).ToList();
            overallMTBF = mtbfValues.Any() ? mtbfValues.Average(r => r.MTBF) : 0;
        }
        else
        {
            overallMTBF = 0;
        }
        
        // Calculate MTTR (Mean Time To Repair) from completed work orders
        var completedWOs = workOrders
            .Where(w => w.Status == "Completed" && w.CompletedDate.HasValue)
            .ToList();
        
        if (completedWOs.Any())
        {
            // Calculate actual repair time for each work order
            var repairTimes = completedWOs
                .Select(wo => (wo.CompletedDate!.Value - wo.CreatedDate).TotalHours)
                .Where(hours => hours > 0 && hours < 720) // Filter out unrealistic values (> 30 days)
                .ToList();
            
            overallMTTR = repairTimes.Any() ? repairTimes.Average() : 0;
        }
        else if (reliabilityMetrics.Any())
        {
            var mttrValues = reliabilityMetrics.Where(r => r.MTTR > 0).ToList();
            overallMTTR = mttrValues.Any() ? mttrValues.Average(r => r.MTTR) : 0;
        }
        else
        {
            overallMTTR = 0;
        }
        
        // Calculate Equipment Availability from assets
        if (assets.Any())
        {
            overallAvailability = assets.Average(a => a.Uptime);
        }
        else if (reliabilityMetrics.Any())
        {
            var availValues = reliabilityMetrics.Where(r => r.Availability > 0).ToList();
            overallAvailability = availValues.Any() ? availValues.Average(r => r.Availability) : 0;
        }
        else
        {
            overallAvailability = 0;
        }
        
        // Calculate Reliability Score (OEE or Health Score)
        if (reliabilityMetrics.Any())
        {
            var oeeValues = reliabilityMetrics.Where(r => r.OEE > 0).ToList();
            overallReliability = oeeValues.Any() ? oeeValues.Average(r => r.OEE) : 0;
        }
        
        // Fallback to health score if no OEE data
        if (overallReliability == 0 && assets.Any())
        {
            overallReliability = assets.Average(a => a.HealthScore);
        }
        
        // Calculate trends by comparing current month vs previous month
        CalculateTrends();
    }
    
    private void CalculateTrends()
    {
        var now = DateTime.Now;
        var currentMonthStart = new DateTime(now.Year, now.Month, 1);
        var previousMonthStart = currentMonthStart.AddMonths(-1);
        var previousMonthEnd = currentMonthStart.AddDays(-1);
        
        // Get metrics for current and previous month
        var currentMetrics = reliabilityMetrics
            .Where(r => r.MetricDate >= currentMonthStart)
            .ToList();
        
        var previousMetrics = reliabilityMetrics
            .Where(r => r.MetricDate >= previousMonthStart && r.MetricDate <= previousMonthEnd)
            .ToList();
        
        if (currentMetrics.Any() && previousMetrics.Any())
        {
            // Calculate averages for each period
            var currentMTBF = currentMetrics.Where(r => r.MTBF > 0).DefaultIfEmpty().Average(r => r?.MTBF ?? 0);
            var previousMTBF = previousMetrics.Where(r => r.MTBF > 0).DefaultIfEmpty().Average(r => r?.MTBF ?? 0);
            
            var currentMTTR = currentMetrics.Where(r => r.MTTR > 0).DefaultIfEmpty().Average(r => r?.MTTR ?? 0);
            var previousMTTR = previousMetrics.Where(r => r.MTTR > 0).DefaultIfEmpty().Average(r => r?.MTTR ?? 0);
            
            var currentAvail = currentMetrics.Where(r => r.Availability > 0).DefaultIfEmpty().Average(r => r?.Availability ?? 0);
            var previousAvail = previousMetrics.Where(r => r.Availability > 0).DefaultIfEmpty().Average(r => r?.Availability ?? 0);
            
            var currentOEE = currentMetrics.Where(r => r.OEE > 0).DefaultIfEmpty().Average(r => r?.OEE ?? 0);
            var previousOEE = previousMetrics.Where(r => r.OEE > 0).DefaultIfEmpty().Average(r => r?.OEE ?? 0);
            
            // Calculate percentage changes
            mtbfTrend = previousMTBF > 0 ? ((currentMTBF - previousMTBF) / previousMTBF) * 100 : 0;
            mttrTrend = previousMTTR > 0 ? ((currentMTTR - previousMTTR) / previousMTTR) * 100 : 0;
            availabilityTrend = previousAvail > 0 ? ((currentAvail - previousAvail) / previousAvail) * 100 : 0;
            reliabilityTrend = previousOEE > 0 ? ((currentOEE - previousOEE) / previousOEE) * 100 : 0;
        }
        else
        {
            // No trend data available - set to 0
            mtbfTrend = 0;
            mttrTrend = 0;
            availabilityTrend = 0;
            reliabilityTrend = 0;
        }
    }
    
    private void GenerateTrendData()
    {
        var months = new[] { "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec" };
        var currentMonth = DateTime.Now.Month;
        var currentYear = DateTime.Now.Year;
        
        mtbfTrendData.Clear();
        mttrTrendData.Clear();
        
        // Generate 12 months of actual historical data
        for (int i = 11; i >= 0; i--)
        {
            var targetDate = DateTime.Now.AddMonths(-i);
            var monthIndex = targetDate.Month - 1; // 0-based index
            var monthLabel = months[monthIndex];
            var year = targetDate.Year;
            var monthStart = new DateTime(year, targetDate.Month, 1);
            var monthEnd = monthStart.AddMonths(1).AddDays(-1);
            
            // Get actual metrics for this month
            var monthMetrics = reliabilityMetrics
                .Where(r => r.MetricDate >= monthStart && r.MetricDate <= monthEnd)
                .ToList();
            
            if (monthMetrics.Any())
            {
                // Use actual average values from reliability metrics
                var mtbfValues = monthMetrics.Where(r => r.MTBF > 0).ToList();
                var mttrValues = monthMetrics.Where(r => r.MTTR > 0).ToList();
                
                var mtbfValue = mtbfValues.Any() ? mtbfValues.Average(r => r.MTBF) : 0;
                var mttrValue = mttrValues.Any() ? mttrValues.Average(r => r.MTTR) : 0;
                
                mtbfTrendData.Add(new SimpleLineChart.ChartDataPoint { Label = monthLabel, Value = mtbfValue });
                mttrTrendData.Add(new SimpleLineChart.ChartDataPoint { Label = monthLabel, Value = mttrValue });
            }
            else
            {
                // Calculate from work orders for this month if no reliability metrics exist
                var monthWorkOrders = workOrders
                    .Where(wo => wo.CreatedDate >= monthStart && wo.CreatedDate <= monthEnd)
                    .ToList();
                
                double mtbfValue = 0;
                double mttrValue = 0;
                
                // Calculate MTTR from completed work orders in this month
                var completedWOs = monthWorkOrders
                    .Where(wo => wo.Status == "Completed" && wo.CompletedDate.HasValue)
                    .ToList();
                
                if (completedWOs.Any())
                {
                    var repairTimes = completedWOs
                        .Select(wo => (wo.CompletedDate!.Value - wo.CreatedDate).TotalHours)
                        .Where(hours => hours > 0 && hours < 720)
                        .ToList();
                    
                    mttrValue = repairTimes.Any() ? repairTimes.Average() : 0;
                }
                
                // Calculate MTBF from failure work orders in this month
                var failures = monthWorkOrders
                    .Where(wo => wo.Type == "Corrective" || wo.Type == "Emergency")
                    .OrderBy(wo => wo.CreatedDate)
                    .ToList();
                
                if (failures.Count > 1)
                {
                    var timeBetweenFailures = new List<double>();
                    for (int j = 1; j < failures.Count; j++)
                    {
                        var hoursBetween = (failures[j].CreatedDate - failures[j-1].CreatedDate).TotalHours;
                        if (hoursBetween > 0)
                        {
                            timeBetweenFailures.Add(hoursBetween);
                        }
                    }
                    mtbfValue = timeBetweenFailures.Any() ? timeBetweenFailures.Average() : 0;
                }
                
                mtbfTrendData.Add(new SimpleLineChart.ChartDataPoint { Label = monthLabel, Value = mtbfValue });
                mttrTrendData.Add(new SimpleLineChart.ChartDataPoint { Label = monthLabel, Value = mttrValue });
            }
        }
    }
    
    private void GenerateParetoData()
    {
        paretoData.Clear();
        
        // Group failure modes by cause/category
        var failureCauses = failureModes
            .GroupBy(f => !string.IsNullOrEmpty(f.Cause) ? f.Cause : f.Mode)
            .Select(g => new { Cause = g.Key, Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(5)
            .ToList();
        
        if (!failureCauses.Any())
        {
            // Fallback: generate from work order types
            failureCauses = workOrders
                .Where(w => w.Status == "Completed")
                .GroupBy(w => w.Type ?? "Unknown")
                .Select(g => new { Cause = g.Key, Count = g.Count() })
                .OrderByDescending(x => x.Count)
                .Take(5)
                .ToList();
        }
        
        var totalCount = failureCauses.Sum(x => x.Count);
        if (totalCount == 0) return;
        
        double cumulative = 0;
        foreach (var cause in failureCauses)
        {
            var percentage = (cause.Count / (double)totalCount) * 100;
            cumulative += percentage;
            
            var impact = cumulative <= 35 ? "Critical" : 
                        cumulative <= 60 ? "High" : 
                        cumulative <= 86 ? "Medium" : "Low";
                        
            var impactClass = impact == "Critical" ? "rbm-badge-critical" :
                             impact == "High" ? "rbm-badge-high" :
                             impact == "Medium" ? "rbm-badge-medium" : "rbm-badge-low";
            
            paretoData.Add(new ParetoItem
            {
                Cause = cause.Cause,
                Occurrences = cause.Count,
                Percentage = percentage,
                Cumulative = cumulative,
                ImpactLevel = impact,
                ImpactClass = impactClass
            });
        }
    }
    
    private void GeneratePredictiveRecommendations()
    {
        predictiveRecommendations.Clear();
        
        // Find assets with low health scores or approaching maintenance
        var atRiskAssets = assets
            .OrderBy(a => a.HealthScore)
            .ThenByDescending(a => 100 - a.Uptime) // Lower uptime = more at risk
            .Take(3)
            .ToList();
        
        foreach (var asset in atRiskAssets)
        {
            var rec = new PredictiveRecommendation
            {
                AssetId = asset.Id,
                AssetName = asset.Name
            };
            
            if (asset.HealthScore < 50)
            {
                rec.RiskLevel = "High Failure Risk";
                rec.Icon = "🚨";
                rec.MainMessage = $"Predicted failure probability: {(100 - asset.HealthScore):F0}% within next 7 days";
                rec.SubMessage = "Based on health score trend analysis and historical failure patterns";
                rec.BackgroundColor = "rgba(229, 57, 53, 0.1)";
                rec.BorderColor = "var(--rbm-danger)";
                rec.TextColor = "var(--rbm-danger)";
                rec.ActionType = "CreateWO";
            }
            else if (asset.HealthScore < 70)
            {
                rec.RiskLevel = "Preventive Action Recommended";
                rec.Icon = "⚠️";
                rec.MainMessage = $"Health score declining: currently at {asset.HealthScore:F0}%";
                rec.SubMessage = "Schedule inspection within 14 days to prevent potential failure";
                rec.BackgroundColor = "rgba(251, 140, 0, 0.1)";
                rec.BorderColor = "var(--rbm-warning)";
                rec.TextColor = "var(--rbm-warning)";
                rec.ActionType = "Schedule";
            }
            else
            {
                rec.RiskLevel = "Optimal Maintenance Window";
                rec.Icon = "ℹ️";
                rec.MainMessage = $"Ideal time for scheduled maintenance: Next week";
                rec.SubMessage = $"Asset running at {asset.Uptime:F0}% availability - schedule during planned downtime";
                rec.BackgroundColor = "rgba(2, 136, 209, 0.1)";
                rec.BorderColor = "var(--rbm-accent)";
                rec.TextColor = "var(--rbm-accent)";
                rec.ActionType = "ViewDetails";
            }
            
            predictiveRecommendations.Add(rec);
        }
    }

    private async Task ExportReport()
    {
        try
        {
            await Task.Delay(500); // Simulate export
            ShowSuccess("Report exported successfully!");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error exporting report: {ex.Message}");
        }
    }

    private async Task CreateWorkOrderForAsset(int assetId, bool isCritical = false)
    {
        var asset = assets.FirstOrDefault(a => a.Id == assetId);
        if (asset != null)
        {
            try
            {
                var newWorkOrder = new WorkOrder
                {
                    AssetId = asset.Id,
                    Priority = isCritical ? "Critical" : "High",
                    Type = isCritical ? "Corrective" : "Predictive",
                    Status = "Open",
                    DueDate = DateTime.Now.AddDays(isCritical ? 1 : 7),
                    AssignedTo = "John Smith",
                    Description = $"AI-generated work order based on {(isCritical ? "critical condition analysis" : "predictive analytics")}",
                    EstimatedDowntime = isCritical ? 6 : 3
                };
                
                await DataService.AddWorkOrderAsync(newWorkOrder);
                workOrders = await DataService.GetWorkOrdersAsync();
                ShowSuccess($"Work order {newWorkOrder.WorkOrderId} created for {asset.Name}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error creating work order: {ex.Message}");
            }
        }
    }

    private async Task CreateScheduleForAsset(int assetId)
    {
        var asset = assets.FirstOrDefault(a => a.Id == assetId);
        if (asset != null)
        {
            try
            {
                var newSchedule = new MaintenanceSchedule
                {
                    AssetId = asset.Id,
                    ScheduledDate = DateTime.Now.AddDays(14).AddHours(8),
                    EndDate = DateTime.Now.AddDays(14).AddHours(11),
                    Type = "Preventive",
                    AssignedTechnician = "Mike Davis",
                    Status = "Scheduled"
                };
                
                await DataService.AddScheduleAsync(newSchedule);
                ShowSuccess($"Maintenance scheduled for {asset.Name} on {newSchedule.ScheduledDate:MMM dd}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error creating schedule: {ex.Message}");
            }
        }
    }

    private void ViewAssetDetails(int assetId)
    {
        Navigation.NavigateTo($"/rbm/assets/{assetId}");
    }

    private void ShowSuccess(string message)
    {
        successMessage = message;
        showSuccessMessage = true;
        StateHasChanged();
        
        Task.Delay(3000).ContinueWith(_ =>
        {
            showSuccessMessage = false;
            InvokeAsync(StateHasChanged);
        });
    }
    
    // Helper classes
    private class ParetoItem
    {
        public string Cause { get; set; } = "";
        public int Occurrences { get; set; }
        public double Percentage { get; set; }
        public double Cumulative { get; set; }
        public string ImpactLevel { get; set; } = "";
        public string ImpactClass { get; set; } = "";
    }
    
    private class PredictiveRecommendation
    {
        public int AssetId { get; set; }
        public string AssetName { get; set; } = "";
        public string RiskLevel { get; set; } = "";
        public string Icon { get; set; } = "";
        public string MainMessage { get; set; } = "";
        public string SubMessage { get; set; } = "";
        public string BackgroundColor { get; set; } = "";
        public string BorderColor { get; set; } = "";
        public string TextColor { get; set; } = "";
        public string ActionType { get; set; } = "";
    }

    private class LocationStats
    {
        public string Name { get; set; } = "";
        public int AssetCount { get; set; }
        public double Availability { get; set; }
        public double AvgHealth { get; set; }
        public int OpenWorkOrders { get; set; }
    }

    private List<LocationStats> GetLocationStats()
    {
        var locations = assets.Select(a => a.Location.Split(',')[0]).Distinct().ToList();
        var stats = new List<LocationStats>();

        foreach (var location in locations)
        {
            var locationAssets = assets.Where(a => a.Location.StartsWith(location)).ToList();
            stats.Add(new LocationStats
            {
                Name = location,
                AssetCount = locationAssets.Count,
                Availability = locationAssets.Any() ? locationAssets.Average(a => a.Uptime) : 0,
                AvgHealth = locationAssets.Any() ? locationAssets.Average(a => a.HealthScore) : 0,
                OpenWorkOrders = workOrders.Count(w => 
                    locationAssets.Any(a => a.Id == w.AssetId) && 
                    w.Status != "Completed")
            });
        }

        return stats.OrderByDescending(s => s.AssetCount).ToList();
    }
}

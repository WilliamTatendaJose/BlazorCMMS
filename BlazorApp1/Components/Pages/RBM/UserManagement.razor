@page "/rbm/users"
@rendermode InteractiveServer
@layout RBMLayout
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@inject BlazorApp1.Services.DataService DataService
@inject BlazorApp1.Services.RolePermissionService PermissionService
@using BlazorApp1.Models

<div class="rbm-page-header">
    <h1 class="rbm-page-title">User Management</h1>
    <p class="rbm-page-subtitle">Manage users and role-based permissions</p>
</div>

<div class="rbm-action-bar">
    <div></div>
    <button class="rbm-btn rbm-btn-primary" @onclick="ShowInviteModal">
        ➕ Add User
    </button>
</div>

<!-- User Statistics -->
<div class="rbm-grid rbm-grid-4">
    <div class="rbm-stat-card">
        <div class="rbm-stat-label">Total Users</div>
        <div class="rbm-stat-value">@users.Count</div>
    </div>
    <div class="rbm-stat-card">
        <div class="rbm-stat-label">Admins</div>
        <div class="rbm-stat-value">@users.Count(u => u.Role == "Admin")</div>
    </div>
    <div class="rbm-stat-card">
        <div class="rbm-stat-label">Engineers</div>
        <div class="rbm-stat-value">@users.Count(u => u.Role == "Reliability Engineer")</div>
    </div>
    <div class="rbm-stat-card">
        <div class="rbm-stat-label">Technicians</div>
        <div class="rbm-stat-value">@users.Count(u => u.Role == "Technician")</div>
    </div>
</div>

<!-- Users Table -->
<div class="rbm-card mt-3">
    <div class="rbm-table-container">
        <table class="rbm-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Department</th>
                    <th>Phone</th>
                    <th>Status</th>
                    <th>Last Login</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in users)
                {
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <img src="https://ui-avatars.com/api/?name=@user.Name.Replace(" ", "+")&background=607d8b&color=fff" 
                                     alt="@user.Name" 
                                     style="width: 36px; height: 36px; border-radius: 50%;">
                                <strong>@user.Name</strong>
                            </div>
                        </td>
                        <td>@user.Email</td>
                        <td>
                            <span class="rbm-badge-pill" style="@GetRoleBadgeStyle(user.Role)">
                                @user.Role
                            </span>
                        </td>
                        <td>@user.Department</td>
                        <td>@user.Phone</td>
                        <td>
                            @if (user.IsActive)
                            {
                                <span class="rbm-badge-pill rbm-badge-success">Active</span>
                            }
                            else
                            {
                                <span class="rbm-badge-pill" style="background: rgba(158, 158, 158, 0.1); color: #9e9e9e;">Inactive</span>
                            }
                        </td>
                        <td>
                            @if (user.LastLoginDate.HasValue)
                            {
                                <div>@user.LastLoginDate.Value.ToString("MMM dd, yyyy")</div>
                                <div style="font-size: 11px; color: var(--rbm-text-light);">
                                    @user.LastLoginDate.Value.ToString("HH:mm")
                                </div>
                            }
                            else
                            {
                                <span style="color: var(--rbm-text-light);">Never</span>
                            }
                        </td>
                        <td>
                            <div style="display: flex; gap: 4px;">
                                <button class="rbm-btn rbm-btn-outline rbm-btn-sm" @onclick="() => EditUser(user)">
                                    ✏️ Edit
                                </button>
                                @if (users.Count > 1)
                                {
                                    <button class="rbm-btn rbm-btn-danger rbm-btn-sm" @onclick="() => ShowDeleteConfirm(user)">
                                        🗑️
                                    </button>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Role Descriptions -->
<div class="rbm-card mt-3">
    <div class="rbm-card-header">
        <h3 class="rbm-card-title">Role Descriptions & Permissions</h3>
    </div>
    <div class="rbm-table-container">
        <table class="rbm-table">
            <thead>
                <tr>
                    <th>Role</th>
                    <th>Description</th>
                    <th>View</th>
                    <th>Edit</th>
                    <th>Delete</th>
                    <th>Manage Users</th>
                    <th>Modify FMEA</th>
                    <th>Create Work Orders</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Admin</strong></td>
                    <td>Full system access and user management</td>
                    <td>✓</td>
                    <td>✓</td>
                    <td>✓</td>
                    <td>✓</td>
                    <td>✓</td>
                    <td>✓</td>
                </tr>
                <tr>
                    <td><strong>Reliability Engineer</strong></td>
                    <td>FMEA, analytics, and maintenance planning</td>
                    <td>✓</td>
                    <td>✓</td>
                    <td>✓</td>
                    <td>✗</td>
                    <td>✓</td>
                    <td>✓</td>
                </tr>
                <tr>
                    <td><strong>Planner</strong></td>
                    <td>Work order and schedule management</td>
                    <td>✓</td>
                    <td>✓</td>
                    <td>✗</td>
                    <td>✗</td>
                    <td>✗</td>
                    <td>✓</td>
                </tr>
                <tr>
                    <td><strong>Technician</strong></td>
                    <td>Execute work orders and record data</td>
                    <td>✓</td>
                    <td>Limited</td>
                    <td>✗</td>
                    <td>✗</td>
                    <td>✗</td>
                    <td>✗</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit User Modal -->
@if (showUserModal)
{
    <div class="rbm-modal-backdrop" @onclick="CloseUserModal">
        <div class="rbm-modal" @onclick:stopPropagation="true">
            <div class="rbm-modal-header">
                <h3 class="rbm-modal-title">@(editMode ? "Edit User" : "Add New User")</h3>
                <button class="rbm-modal-close" @onclick="CloseUserModal">&times;</button>
            </div>
            <div class="rbm-modal-body">
                <div class="rbm-form-group">
                    <label class="rbm-form-label">Full Name</label>
                    <input type="text" class="rbm-form-input" @bind="currentUser.Name" placeholder="John Doe">
                </div>
                <div class="rbm-form-group">
                    <label class="rbm-form-label">Email Address</label>
                    <input type="email" class="rbm-form-input" @bind="currentUser.Email" placeholder="john.doe@company.com">
                </div>
                <div class="rbm-grid rbm-grid-2">
                    <div class="rbm-form-group">
                        <label class="rbm-form-label">Role</label>
                        <select class="rbm-form-select" @bind="currentUser.Role">
                            <option value="Technician">Technician</option>
                            <option value="Planner">Planner</option>
                            <option value="Reliability Engineer">Reliability Engineer</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                    <div class="rbm-form-group">
                        <label class="rbm-form-label">Department</label>
                        <input type="text" class="rbm-form-input" @bind="currentUser.Department" placeholder="Maintenance">
                    </div>
                </div>
                
                <div class="rbm-form-group">
                    <label class="rbm-form-label">Phone Number</label>
                    <input type="tel" class="rbm-form-input" @bind="currentUser.Phone" placeholder="555-0123">
                </div>
                
                <div class="rbm-form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" @bind="currentUser.IsActive">
                        <span>Active User</span>
                    </label>
                </div>
                
                <div style="padding: 16px; background: var(--rbm-bg); border-radius: 8px; margin-top: 16px;">
                    <strong style="display: block; margin-bottom: 8px;">Role Permissions</strong>
                    <p style="font-size: 13px; color: var(--rbm-text-light); margin-bottom: 12px;">
                        Permissions are automatically assigned based on the selected role.
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 14px;">
                        <div>✓ View: All roles</div>
                        <div>@(GetPermissionText("Edit", currentUser.Role))</div>
                        <div>@(GetPermissionText("Delete", currentUser.Role))</div>
                        <div>@(GetPermissionText("Manage Users", currentUser.Role))</div>
                        <div>@(GetPermissionText("Create Work Orders", currentUser.Role))</div>
                        <div>@(GetPermissionText("Modify FMEA", currentUser.Role))</div>
                    </div>
                </div>
                
                @if (!editMode)
                {
                    <div style="margin-top: 16px; padding: 12px; background: rgba(2, 136, 209, 0.1); border-left: 4px solid var(--rbm-accent); border-radius: 4px;">
                        <p style="margin: 0; font-size: 13px; color: var(--rbm-text);">
                            ℹ️ <strong>Note:</strong> For production, this user should be created through ASP.NET Core Identity with a proper password. This demo uses simplified user creation.
                        </p>
                    </div>
                }
            </div>
            <div class="rbm-modal-footer">
                <button class="rbm-btn rbm-btn-outline" @onclick="CloseUserModal">Cancel</button>
                <button class="rbm-btn rbm-btn-primary" @onclick="SaveUser">
                    @(editMode ? "Save Changes" : "Add User")
                </button>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirm)
{
    <div class="rbm-modal-backdrop" @onclick="CloseDeleteConfirm">
        <div class="rbm-modal" @onclick:stopPropagation="true" style="max-width: 500px;">
            <div class="rbm-modal-header">
                <h3 class="rbm-modal-title">Confirm Delete</h3>
                <button class="rbm-modal-close" @onclick="CloseDeleteConfirm">&times;</button>
            </div>
            <div class="rbm-modal-body">
                <div style="padding: 20px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
                    <p style="font-size: 16px; margin-bottom: 12px;">
                        Are you sure you want to delete <strong>@userToDelete?.Name</strong>?
                    </p>
                    <p style="font-size: 14px; color: var(--rbm-text-light);">
                        This action cannot be undone.
                    </p>
                </div>
            </div>
            <div class="rbm-modal-footer">
                <button class="rbm-btn rbm-btn-outline" @onclick="CloseDeleteConfirm">Cancel</button>
                <button class="rbm-btn rbm-btn-danger" @onclick="ConfirmDelete">Delete User</button>
            </div>
        </div>
    </div>
}

@if (showSuccessMessage)
{
    <div style="position: fixed; top: 80px; right: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; border-left: 4px solid var(--rbm-success);">
        <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 24px;">✓</span>
            <div>
                <div style="font-weight: 600; color: var(--rbm-success);">Success!</div>
                <div style="font-size: 14px; color: var(--rbm-text-light);">@successMessage</div>
            </div>
        </div>
    </div>
}

@code {
    private List<User> users = new();
    private User currentUser = new();
    private User? userToDelete;
    private bool showUserModal = false;
    private bool showDeleteConfirm = false;
    private bool editMode = false;
    private bool showSuccessMessage = false;
    private string successMessage = "";

    protected override void OnInitialized()
    {
        users = DataService.GetUsers();
    }

    private void ShowInviteModal()
    {
        currentUser = new User 
        { 
            Role = "Technician", 
            IsActive = true,
            CreatedDate = DateTime.Now
        };
        editMode = false;
        showUserModal = true;
    }

    private void CloseUserModal()
    {
        showUserModal = false;
    }

    private void EditUser(User user)
    {
        currentUser = new User
        {
            Id = user.Id,
            Name = user.Name,
            Email = user.Email,
            Role = user.Role,
            Department = user.Department,
            Phone = user.Phone,
            IsActive = user.IsActive,
            CreatedDate = user.CreatedDate,
            LastLoginDate = user.LastLoginDate,
            Notes = user.Notes
        };
        editMode = true;
        showUserModal = true;
    }

    private void SaveUser()
    {
        if (string.IsNullOrWhiteSpace(currentUser.Name) || string.IsNullOrWhiteSpace(currentUser.Email))
        {
            return;
        }

        if (editMode)
        {
            DataService.UpdateUser(currentUser);
            ShowSuccess("User updated successfully!");
        }
        else
        {
            DataService.AddUser(currentUser);
            ShowSuccess($"User {currentUser.Name} added successfully!");
        }
        
        users = DataService.GetUsers();
        CloseUserModal();
    }

    private void ShowDeleteConfirm(User user)
    {
        userToDelete = user;
        showDeleteConfirm = true;
    }

    private void CloseDeleteConfirm()
    {
        showDeleteConfirm = false;
        userToDelete = null;
    }

    private void ConfirmDelete()
    {
        if (userToDelete != null)
        {
            DataService.DeleteUser(userToDelete.Id);
            users = DataService.GetUsers();
            ShowSuccess($"User {userToDelete.Name} deleted successfully!");
        }
        CloseDeleteConfirm();
    }

    private void ShowSuccess(string message)
    {
        successMessage = message;
        showSuccessMessage = true;
        StateHasChanged();
        
        Task.Delay(3000).ContinueWith(_ =>
        {
            showSuccessMessage = false;
            InvokeAsync(StateHasChanged);
        });
    }

    private string GetRoleBadgeStyle(string role)
    {
        return role switch
        {
            "Admin" => "background: rgba(229, 57, 53, 0.1); color: var(--rbm-danger);",
            "Reliability Engineer" => "background: rgba(2, 136, 209, 0.1); color: var(--rbm-accent);",
            "Planner" => "background: rgba(251, 140, 0, 0.1); color: var(--rbm-warning);",
            "Technician" => "background: rgba(67, 160, 71, 0.1); color: var(--rbm-success);",
            _ => ""
        };
    }

    private string GetPermissionText(string permission, string role)
    {
        var hasPermission = permission switch
        {
            "Edit" => role == "Admin" || role == "Reliability Engineer" || role == "Planner" || role == "Technician",
            "Delete" => role == "Admin" || role == "Reliability Engineer",
            "Manage Users" => role == "Admin",
            "Create Work Orders" => role == "Admin" || role == "Reliability Engineer" || role == "Planner",
            "Modify FMEA" => role == "Admin" || role == "Reliability Engineer",
            _ => false
        };

        return hasPermission ? $"✓ {permission}" : $"✗ {permission}";
    }
}

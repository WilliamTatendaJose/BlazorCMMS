@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using BlazorApp1.Models
@using BlazorApp1.Services
@attribute [Authorize]
@inject UnitsSettingsService UnitsSettings
@inject NavigationManager Navigation

<div class="rbm-card units-settings-card">
    <div class="rbm-card-header">
        <h3 class="rbm-card-title">⚙️ Units & Measurements</h3>
        <span class="units-header-status">@(isSaving ? "⏳ Saving..." : "✓ Ready")</span>
    </div>

    @if (!isInitialized)
    {
        <div class="units-loading-state">
            <div style="padding: 40px; text-align: center;">
                <div style="font-size: 24px; margin-bottom: 12px;">⏳</div>
                <div style="color: var(--rbm-text-light);">Loading your preferences...</div>
            </div>
        </div>
    }
    else
    {
        <div style="padding: 20px;">
            <!-- Unit System Selection -->
            <div class="rbm-form-group">
                <label class="rbm-form-label">
                    <strong>Preferred Unit System</strong>
                    <span class="units-label-hint">Global default for all measurements</span>
                </label>
                <div class="units-system-selector">
                    <label class="units-system-option @(settings.PreferredUnitSystem == "imperial" ? "units-system-active" : "")">
                        <input type="radio" name="unitSystem" value="imperial" 
                               @onchange="@((ChangeEventArgs e) => OnUnitSystemChanged(e.Value?.ToString()))" 
                               checked="@(settings.PreferredUnitSystem == "imperial")" 
                               disabled="@isSaving"
                               class="units-radio" />
                        <span class="units-system-content">
                            <div class="units-system-title">🇺🇸 Imperial</div>
                            <div class="units-system-description">°F, PSI, GPM</div>
                        </span>
                    </label>

                    <label class="units-system-option @(settings.PreferredUnitSystem == "metric" ? "units-system-active" : "")">
                        <input type="radio" name="unitSystem" value="metric" 
                               @onchange="@((ChangeEventArgs e) => OnUnitSystemChanged(e.Value?.ToString()))" 
                               checked="@(settings.PreferredUnitSystem == "metric")" 
                               disabled="@isSaving"
                               class="units-radio" />
                        <span class="units-system-content">
                            <div class="units-system-title">🌍 Metric</div>
                            <div class="units-system-description">°C, bar, L/min</div>
                        </span>
                    </label>

                    <label class="units-system-option @(settings.PreferredUnitSystem == "si" ? "units-system-active" : "")">
                        <input type="radio" name="unitSystem" value="si" 
                               @onchange="@((ChangeEventArgs e) => OnUnitSystemChanged(e.Value?.ToString()))" 
                               checked="@(settings.PreferredUnitSystem == "si")" 
                               disabled="@isSaving"
                               class="units-radio" />
                        <span class="units-system-content">
                            <div class="units-system-title">📐 SI</div>
                            <div class="units-system-description">°C, Pa, m³/s</div>
                        </span>
                    </label>
                </div>
            </div>

            <hr class="units-divider" />

            <!-- Individual Unit Overrides -->
            <div style="margin-bottom: 20px;">
                <div class="units-section-header">
                    <span>Individual Unit Preferences</span>
                    <span class="units-section-hint">(Optional - Leave empty to use system default)</span>
                </div>

                <div class="units-grid">
                    <div class="rbm-form-group">
                        <label class="rbm-form-label">
                            <span class="units-icon">🌡️</span>
                            <span>Temperature</span>
                        </label>
                        <select class="rbm-form-select" 
                                @bind="settings.TemperatureUnit" 
                                @bind:after="SaveSettings"
                                disabled="@isSaving"
                                title="Leave empty to use system default (Imperial: °F, Metric/SI: °C)">
                            <option value="">@GetSystemDefault("temperature") (System Default)</option>
                            <option value="°F">Fahrenheit (°F)</option>
                            <option value="°C">Celsius (°C)</option>
                            <option value="K">Kelvin (K)</option>
                        </select>
                        <small class="units-hint">System default: @GetSystemDefault("temperature")</small>
                    </div>

                    <div class="rbm-form-group">
                        <label class="rbm-form-label">
                            <span class="units-icon">⚡</span>
                            <span>Pressure</span>
                        </label>
                        <select class="rbm-form-select" 
                                @bind="settings.PressureUnit" 
                                @bind:after="SaveSettings"
                                disabled="@isSaving"
                                title="Leave empty to use system default (Imperial: PSI, Metric: bar, SI: Pa)">
                            <option value="">@GetSystemDefault("pressure") (System Default)</option>
                            <option value="PSI">PSI (lb/in²)</option>
                            <option value="bar">Bar</option>
                            <option value="Pa">Pascal (Pa)</option>
                            <option value="atm">Atmosphere (atm)</option>
                            <option value="kPa">Kilopascal (kPa)</option>
                        </select>
                        <small class="units-hint">System default: @GetSystemDefault("pressure")</small>
                    </div>

                    <div class="rbm-form-group">
                        <label class="rbm-form-label">
                            <span class="units-icon">💧</span>
                            <span>Flow Rate</span>
                        </label>
                        <select class="rbm-form-select" 
                                @bind="settings.FlowRateUnit" 
                                @bind:after="SaveSettings"
                                disabled="@isSaving"
                                title="Leave empty to use system default (Imperial: GPM, Metric: L/min, SI: m³/s)">
                            <option value="">@GetSystemDefault("flow") (System Default)</option>
                            <option value="GPM">GPM (US)</option>
                            <option value="L/min">L/min</option>
                            <option value="m³/s">m³/s</option>
                            <option value="m³/h">m³/h</option>
                            <option value="L/s">L/s</option>
                        </select>
                        <small class="units-hint">System default: @GetSystemDefault("flow")</small>
                    </div>

                    <div class="rbm-form-group">
                        <label class="rbm-form-label">
                            <span class="units-icon">⚖️</span>
                            <span>Weight</span>
                        </label>
                        <select class="rbm-form-select" 
                                @bind="settings.WeightUnit" 
                                @bind:after="SaveSettings"
                                disabled="@isSaving"
                                title="Leave empty to use system default (Imperial: lb, Metric/SI: kg)">
                            <option value="">@GetSystemDefault("weight") (System Default)</option>
                            <option value="lb">Pounds (lb)</option>
                            <option value="kg">Kilogram (kg)</option>
                            <option value="g">Gram (g)</option>
                            <option value="ton">Metric Ton</option>
                        </select>
                        <small class="units-hint">System default: @GetSystemDefault("weight")</small>
                    </div>

                    <div class="rbm-form-group">
                        <label class="rbm-form-label">
                            <span class="units-icon">📏</span>
                            <span>Length</span>
                        </label>
                        <select class="rbm-form-select" 
                                @bind="settings.LengthUnit" 
                                @bind:after="SaveSettings"
                                disabled="@isSaving"
                                title="Leave empty to use system default (Imperial: in, Metric: mm, SI: m)">
                            <option value="">@GetSystemDefault("length") (System Default)</option>
                            <option value="in">Inch (in)</option>
                            <option value="ft">Foot (ft)</option>
                            <option value="m">Meter (m)</option>
                            <option value="mm">Millimeter (mm)</option>
                            <option value="cm">Centimeter (cm)</option>
                        </select>
                        <small class="units-hint">System default: @GetSystemDefault("length")</small>
                    </div>

                    <div class="rbm-form-group">
                        <label class="rbm-form-label">
                            <span class="units-icon">🛣️</span>
                            <span>Distance</span>
                        </label>
                        <select class="rbm-form-select" 
                                @bind="settings.DistanceUnit" 
                                @bind:after="SaveSettings"
                                disabled="@isSaving"
                                title="Leave empty to use system default (Imperial: mi, Metric: km, SI: m)">
                            <option value="">@GetSystemDefault("distance") (System Default)</option>
                            <option value="mi">Mile (mi)</option>
                            <option value="km">Kilometer (km)</option>
                            <option value="m">Meter (m)</option>
                        </select>
                        <small class="units-hint">System default: @GetSystemDefault("distance")</small>
                    </div>
                </div>
            </div>

            <hr class="units-divider" />

            <!-- Formatting Options -->
            <div style="margin-bottom: 20px;">
                <div class="units-section-header">
                    <span>Format Preferences</span>
                    <span class="units-section-hint">(How dates, times, and numbers are displayed)</span>
                </div>

                <div class="units-grid">
                    <div class="rbm-form-group">
                        <label class="rbm-form-label">
                            <span class="units-icon">#</span>
                            <span>Decimal Places</span>
                        </label>
                        <select class="rbm-form-select" 
                                @bind="settings.DecimalPlaces" 
                                @bind:after="SaveSettings"
                                disabled="@isSaving"
                                title="Number of decimal places for measurements">
                            <option value="0">0 (e.g., 85)</option>
                            <option value="1">1 (e.g., 85.5)</option>
                            <option value="2">2 (e.g., 85.50)</option>
                            <option value="3">3 (e.g., 85.500)</option>
                            <option value="4">4 (e.g., 85.5000)</option>
                        </select>
                    </div>

                    <div class="rbm-form-group">
                        <label class="rbm-form-label">
                            <span class="units-icon">📅</span>
                            <span>Date Format</span>
                        </label>
                        <select class="rbm-form-select" 
                                @bind="settings.DateFormat" 
                                @bind:after="SaveSettings"
                                disabled="@isSaving"
                                title="Date format used throughout the application">
                            <option value="MM/dd/yyyy">MM/dd/yyyy (12/15/2024)</option>
                            <option value="dd/MM/yyyy">dd/MM/yyyy (15/12/2024)</option>
                            <option value="yyyy-MM-dd">yyyy-MM-dd (2024-12-15)</option>
                        </select>
                    </div>

                    <div class="rbm-form-group">
                        <label class="rbm-form-label">
                            <span class="units-icon">🕐</span>
                            <span>Time Format</span>
                        </label>
                        <select class="rbm-form-select" 
                                @bind="settings.TimeFormat" 
                                @bind:after="SaveSettings"
                                disabled="@isSaving"
                                title="Time format used throughout the application">
                            <option value="12h">12-hour (2:30 PM)</option>
                            <option value="24h">24-hour (14:30)</option>
                        </select>
                    </div>
                </div>
            </div>

            <hr class="units-divider" />

            <!-- Notifications -->
            <div class="units-notifications-section">
                <div class="units-section-header">
                    <span>Notification Preferences</span>
                    <span class="units-section-hint">(Control how you receive alerts and updates)</span>
                </div>

                <div class="units-checkbox-group">
                    <label class="units-checkbox-label">
                        <input type="checkbox" 
                               @bind="settings.EnableNotifications" 
                               @bind:after="SaveSettings"
                               disabled="@isSaving"
                               class="units-checkbox"
                               title="Enable or disable all notifications" />
                        <span class="units-checkbox-content">
                            <strong>Enable Notifications</strong>
                            <small>Receive alerts for important events and updates</small>
                        </span>
                    </label>
                </div>

                @if (settings.EnableNotifications)
                {
                    <div class="rbm-form-group units-notification-frequency">
                        <label class="rbm-form-label">
                            <span class="units-icon">⏱️</span>
                            <span>Notification Frequency</span>
                        </label>
                        <select class="rbm-form-select" 
                                @bind="settings.NotificationFrequency" 
                                @bind:after="SaveSettings"
                                disabled="@isSaving"
                                title="How often you want to receive notification summaries">
                            <option value="immediate">Immediate (Real-time alerts)</option>
                            <option value="hourly">Hourly Summary (Once per hour)</option>
                            <option value="daily">Daily Summary (Once per day)</option>
                        </select>
                    </div>
                }
            </div>

            <!-- Status Messages -->
            <div class="units-messages-container">
                @if (!string.IsNullOrEmpty(message))
                {
                    <div class="units-settings-message" role="status" aria-live="polite">
                        <span class="units-message-icon">✓</span>
                        <span class="units-message-text">@message</span>
                    </div>
                }

                @if (!string.IsNullOrEmpty(errorMsg))
                {
                    <div class="units-settings-error" role="alert" aria-live="assertive">
                        <span class="units-error-icon">⚠️</span>
                        <span class="units-error-text">@errorMsg</span>
                        <button class="units-error-close" 
                                @onclick="() => errorMsg = string.Empty"
                                aria-label="Close error message"
                                type="button">
                            ✕
                        </button>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    /* Container */
    .units-settings-card {
        position: relative;
    }

    .units-header-status {
        font-size: 12px;
        color: var(--rbm-text-light);
        font-weight: 500;
        margin-left: auto;
    }

    /* Loading State */
    .units-loading-state {
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Unit System Selector */
    .units-system-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
        margin-top: 12px;
    }

    .units-system-option {
        display: flex;
        align-items: flex-start;
        padding: 12px;
        border: 2px solid var(--rbm-border);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .units-system-option:hover {
        border-color: #1976d2;
        background: rgba(25, 118, 210, 0.02);
    }

    .units-system-option.units-system-active {
        border-color: #1976d2;
        background: rgba(25, 118, 210, 0.05);
    }

    .units-radio {
        margin-right: 10px;
        margin-top: 2px;
        cursor: pointer;
        accent-color: #1976d2;
    }

    .units-system-content {
        flex: 1;
    }

    .units-system-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 2px;
        color: var(--rbm-text);
    }

    .units-system-description {
        font-size: 12px;
        color: var(--rbm-text-light);
    }

    /* Grid Layout */
    .units-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 12px;
    }

    /* Section Headers */
    .units-section-header {
        font-weight: 600;
        margin-bottom: 16px;
        color: var(--rbm-text);
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .units-section-hint {
        font-size: 12px;
        color: var(--rbm-text-light);
        font-weight: 400;
    }

    .units-label-hint {
        display: block;
        font-size: 12px;
        font-weight: 400;
        color: var(--rbm-text-light);
        margin-top: 2px;
    }

    /* Form Elements */
    .rbm-form-label {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 8px;
    }

    .units-icon {
        font-size: 14px;
    }

    .units-hint {
        display: block;
        color: var(--rbm-text-light);
        font-size: 11px;
        margin-top: 4px;
    }

    /* Checkboxes */
    .units-checkbox-group {
        margin-top: 12px;
    }

    .units-checkbox-label {
        display: flex;
        align-items: flex-start;
        padding: 12px;
        background: var(--rbm-bg);
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
        gap: 10px;
    }

    .units-checkbox-label:hover {
        background: rgba(25, 118, 210, 0.05);
    }

    .units-checkbox {
        margin-top: 2px;
        cursor: pointer;
        accent-color: #1976d2;
        flex-shrink: 0;
    }

    .units-checkbox-content {
        flex: 1;
    }

    .units-checkbox-content strong {
        display: block;
        margin-bottom: 2px;
        color: var(--rbm-text);
    }

    .units-checkbox-content small {
        color: var(--rbm-text-light);
        font-size: 12px;
    }

    .units-notification-frequency {
        margin-top: 12px;
        margin-left: 28px;
    }

    /* Notifications Section */
    .units-notifications-section {
        margin-bottom: 20px;
    }

    /* Dividers */
    .units-divider {
        margin: 24px 0;
        border: none;
        border-top: 1px solid var(--rbm-border);
    }

    /* Messages Container */
    .units-messages-container {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    /* Success Message */
    .units-settings-message {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: #e8f5e9;
        border-left: 4px solid #43a047;
        border-radius: 6px;
        color: #2e7d32;
        font-size: 14px;
        animation: units-slideIn 0.3s ease;
    }

    .units-message-icon {
        font-size: 16px;
        flex-shrink: 0;
    }

    .units-message-text {
        flex: 1;
    }

    /* Error Message */
    .units-settings-error {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: #ffebee;
        border-left: 4px solid #e53935;
        border-radius: 6px;
        color: #c62828;
        font-size: 14px;
        animation: units-slideIn 0.3s ease;
    }

    .units-error-icon {
        font-size: 16px;
        flex-shrink: 0;
    }

    .units-error-text {
        flex: 1;
    }

    .units-error-close {
        background: none;
        border: none;
        color: inherit;
        cursor: pointer;
        font-size: 16px;
        padding: 0;
        margin-left: 8px;
        flex-shrink: 0;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .units-error-close:hover {
        opacity: 1;
    }

    /* Animations */
    @@keyframes units-slideIn {
        from {
            opacity: 0;
            transform: translateY(-8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Disabled State */
    select:disabled,
    input:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Accessibility */
    @@media (max-width: 600px) {
        .units-system-selector {
            grid-template-columns: 1fr;
        }

        .units-grid {
            grid-template-columns: 1fr;
        }

        .units-section-header {
            flex-direction: column;
            align-items: flex-start;
        }
    }

    /* Reduced Motion */
    @@media (prefers-reduced-motion: reduce) {
        .units-settings-message,
        .units-settings-error,
        .units-system-option {
            animation: none !important;
            transition: none !important;
        }
    }

    /* Focus Styles */
    .units-system-option:focus-within {
        box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
    }

    input:focus-visible,
    select:focus-visible {
        outline: 2px solid #1976d2;
        outline-offset: 2px;
    }
</style>

@code {
    [Parameter]
    public UserSettings? InitialSettings { get; set; }

    private UserSettings settings = new();
    private string message = string.Empty;
    private string errorMsg = string.Empty;
    private bool isSaving = false;
    private bool isInitialized = false;
    private CancellationTokenSource? messageTimeoutCts;
    private const int MessageDisplayDurationMs = 3000;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (InitialSettings != null)
            {
                settings = new UserSettings
                {
                    Id = InitialSettings.Id,
                    UserId = InitialSettings.UserId,
                    PreferredUnitSystem = InitialSettings.PreferredUnitSystem,
                    TemperatureUnit = InitialSettings.TemperatureUnit,
                    PressureUnit = InitialSettings.PressureUnit,
                    FlowRateUnit = InitialSettings.FlowRateUnit,
                    WeightUnit = InitialSettings.WeightUnit,
                    LengthUnit = InitialSettings.LengthUnit,
                    DistanceUnit = InitialSettings.DistanceUnit,
                    DateFormat = InitialSettings.DateFormat,
                    TimeFormat = InitialSettings.TimeFormat,
                    DecimalPlaces = InitialSettings.DecimalPlaces,
                    EnableNotifications = InitialSettings.EnableNotifications,
                    NotificationFrequency = InitialSettings.NotificationFrequency,
                    CreatedDate = InitialSettings.CreatedDate,
                    ModifiedDate = InitialSettings.ModifiedDate
                };
            }
            isInitialized = true;
        }
        catch (Exception ex)
        {
            errorMsg = $"Failed to load settings: {ex.Message}";
            isInitialized = true;
        }
    }

    private async Task OnUnitSystemChanged(string? newSystem)
    {
        if (!string.IsNullOrEmpty(newSystem) && newSystem != settings.PreferredUnitSystem)
        {
            settings.PreferredUnitSystem = newSystem;
            await SaveSettings();
        }
    }

    private async Task SaveSettings()
    {
        if (isSaving || !isInitialized) return;

        try
        {
            isSaving = true;
            errorMsg = string.Empty;
            message = string.Empty;
            
            StateHasChanged();

            await UnitsSettings.UpdateSettingsAsync(settings);
            
            message = "✓ Settings saved successfully";
            StateHasChanged();

            // Cancel previous timeout if exists
            messageTimeoutCts?.Cancel();
            messageTimeoutCts = new CancellationTokenSource();

            // Auto-clear message after delay
            await Task.Delay(MessageDisplayDurationMs, messageTimeoutCts.Token);
            if (!messageTimeoutCts.Token.IsCancellationRequested)
            {
                message = string.Empty;
                StateHasChanged();
            }
        }
        catch (OperationCanceledException)
        {
            // Message was cleared by user or new save started
        }
        catch (UnauthorizedAccessException)
        {
            errorMsg = "You don't have permission to save these settings. Please refresh and try again.";
        }
        catch (InvalidOperationException ex)
        {
            errorMsg = $"Invalid setting value: {ex.Message}";
        }
        catch (Exception ex)
        {
            errorMsg = $"Error saving settings: {ex.Message}";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private string GetSystemDefault(string unitType)
    {
        return (settings.PreferredUnitSystem, unitType) switch
        {
            ("imperial", "temperature") => "°F",
            ("imperial", "pressure") => "PSI",
            ("imperial", "flow") => "GPM",
            ("imperial", "weight") => "lb",
            ("imperial", "length") => "in",
            ("imperial", "distance") => "mi",

            ("metric", "temperature") => "°C",
            ("metric", "pressure") => "bar",
            ("metric", "flow") => "L/min",
            ("metric", "weight") => "kg",
            ("metric", "length") => "mm",
            ("metric", "distance") => "km",

            ("si", "temperature") => "°C",
            ("si", "pressure") => "Pa",
            ("si", "flow") => "m³/s",
            ("si", "weight") => "kg",
            ("si", "length") => "m",
            ("si", "distance") => "m",

            _ => "Unknown"
        };
    }

    public async ValueTask DisposeAsync()
    {
        messageTimeoutCts?.Cancel();
        messageTimeoutCts?.Dispose();
    }
}

@page "/rbm/tenants"
@using BlazorApp1.Services
@using BlazorApp1.Models
@using BlazorApp1.Data
@using Microsoft.AspNetCore.Authorization

@layout RBMLayout
@rendermode InteractiveServer

@inject ITenantManagementService TenantManagementService
@inject ITenantService TenantService
@inject NavigationManager NavigationManager
@inject RolePermissionService RolePermissionService

@attribute [Authorize(Roles = "SuperAdmin")]

<PageTitle>Tenant Management | RBM CMMS</PageTitle>

<div class="rbm-page-header">
    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
            <h1 class="rbm-page-title">🏢 Tenant Management</h1>
            <p class="rbm-page-subtitle">SuperAdmin - Manage all tenants and their configurations</p>
        </div>
        <button class="rbm-btn rbm-btn-primary" @onclick="OpenCreateTenantModal" disabled="@(isLoading || isSaving)">
            <span>➕</span> Create New Tenant
        </button>
    </div>
</div>

<!-- Alert Messages -->
@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="rbm-alert rbm-alert-danger" style="margin-bottom: 20px;">
        <span>⚠️</span>
        <strong>Error:</strong> @errorMessage
        <button class="rbm-alert-close" @onclick="() => errorMessage = null">✕</button>
    </div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="rbm-alert rbm-alert-success" style="margin-bottom: 20px;">
        <span>✅</span>
        <strong>Success:</strong> @successMessage
        <button class="rbm-alert-close" @onclick="() => successMessage = null">✕</button>
    </div>
}

<!-- Statistics Cards -->
<div class="rbm-stats-grid" style="margin-bottom: 24px;margin-top:24px">
    <div class="rbm-stat-card">
        <div class="rbm-stat-icon" style="background: rgba(33, 150, 243, 0.1); color: #2196F3;">🏢</div>
        <div class="rbm-stat-content">
            <div class="rbm-stat-value">@tenants.Count</div>
            <div class="rbm-stat-label">Total Tenants</div>
        </div>
    </div>
    <div class="rbm-stat-card">
        <div class="rbm-stat-icon" style="background: rgba(76, 175, 80, 0.1); color: #4CAF50;">✅</div>
        <div class="rbm-stat-content">
            <div class="rbm-stat-value">@tenants.Count(t => t.IsActive)</div>
            <div class="rbm-stat-label">Active Tenants</div>
        </div>
    </div>
    <div class="rbm-stat-card">
        <div class="rbm-stat-icon" style="background: rgba(255, 152, 0, 0.1); color: #FF9800;">⏸️</div>
        <div class="rbm-stat-content">
            <div class="rbm-stat-value">@tenants.Count(t => !t.IsActive)</div>
            <div class="rbm-stat-label">Inactive Tenants</div>
        </div>
    </div>
    <div class="rbm-stat-card">
        <div class="rbm-stat-icon" style="background: rgba(156, 39, 176, 0.1); color: #9C27B0;">👥</div>
        <div class="rbm-stat-content">
            <div class="rbm-stat-value">@tenants.Sum(t => t.Users?.Count ?? 0)</div>
            <div class="rbm-stat-label">Total Users</div>
        </div>
    </div>
</div>

<!-- Loading State -->
@if (isLoading)
{
    <div class="rbm-card" style="text-align: center; padding: 60px;">
        <div style="font-size: 48px; margin-bottom: 16px;">⏳</div>
        <p style="color: var(--rbm-text-light);">Loading tenants...</p>
    </div>
}
else if (tenants.Count > 0)
{
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
        @foreach (var tenant in tenants)
        {
            <div class="rbm-card" style="overflow: hidden;">
                <div style="background: linear-gradient(135deg, var(--rbm-primary) 0%, #455a64 100%); color: white; padding: 16px 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 600;">@tenant.Name</h3>
                            <span style="font-size: 12px; opacity: 0.8;">@tenant.TenantCode</span>
                        </div>
                        <span class="rbm-badge @(tenant.IsActive ? "rbm-badge-success" : "rbm-badge-secondary")">
                            @(tenant.IsActive ? "Active" : "Inactive")
                        </span>
                    </div>
                </div>
                <div style="padding: 20px;">
                    <div style="display: grid; gap: 12px; font-size: 14px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--rbm-text-light);">👤 Contact:</span>
                            <span style="font-weight: 500;">@(tenant.ContactPerson ?? "Not set")</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--rbm-text-light);">📧 Email:</span>
                            <span style="font-weight: 500;">@(tenant.ContactEmail ?? "Not set")</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--rbm-text-light);">👥 Users:</span>
                            <span style="font-weight: 500;">@(tenant.Users?.Count ?? 0) / @tenant.MaxUsers</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--rbm-text-light);">🏭 Max Assets:</span>
                            <span style="font-weight: 500;">@tenant.MaxAssets</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--rbm-text-light);">📄 Max Documents:</span>
                            <span style="font-weight: 500;">@tenant.MaxDocuments</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--rbm-text-light);">📅 Created:</span>
                            <span style="font-weight: 500;">@tenant.CreatedDate.ToString("MMM dd, yyyy")</span>
                        </div>
                    </div>
                </div>
                <div style="padding: 12px 20px; border-top: 1px solid var(--rbm-border); display: flex; gap: 8px;">
                    <button class="rbm-btn rbm-btn-sm rbm-btn-outline" @onclick="() => OpenEditTenantModal(tenant)" disabled="@isSaving">
                        ✏️ Edit
                    </button>
                    <button class="rbm-btn rbm-btn-sm rbm-btn-outline" @onclick="() => ManageTenantUsers(tenant.Id)" disabled="@isSaving">
                        👥 Users
                    </button>
                    @if (tenant.IsActive)
                    {
                        <button class="rbm-btn rbm-btn-sm rbm-btn-warning" @onclick="() => ConfirmDeactivateTenant(tenant.Id, tenant.Name)" disabled="@isSaving">
                            ⏸️
                        </button>
                    }
                    else
                    {
                        <button class="rbm-btn rbm-btn-sm rbm-btn-success" @onclick="() => ActivateTenant(tenant.Id)" disabled="@isSaving">
                            ▶️
                        </button>
                    }
                    <button class="rbm-btn rbm-btn-sm rbm-btn-danger" @onclick="() => ConfirmDeleteTenant(tenant.Id, tenant.Name)" disabled="@isSaving">
                        🗑️
                    </button>
                </div>
            </div>
        }
    </div>
}
else
{
    <div class="rbm-card" style="text-align: center; padding: 60px;">
        <div style="font-size: 64px; margin-bottom: 16px;">🏢</div>
        <h3 style="margin-bottom: 8px;">No Tenants Found</h3>
        <p style="color: var(--rbm-text-light); margin-bottom: 24px;">Create your first tenant to get started with multi-tenancy.</p>
        <button class="rbm-btn rbm-btn-primary" @onclick="OpenCreateTenantModal">
            ➕ Create First Tenant
        </button>
    </div>
}

<!-- Create/Edit Modal -->
@if (showTenantModal && editingTenant != null)
{
    <div class="rbm-modal-overlay" @onclick="CloseTenantModal">
        <div class="rbm-modal" @onclick:stopPropagation="true" style="max-width: 600px;">
            <div class="rbm-modal-header">
                <h3>@(editingTenant.Id > 0 ? "Edit Tenant" : "Create New Tenant")</h3>
                <button class="rbm-modal-close" @onclick="CloseTenantModal" disabled="@isSaving">✕</button>
            </div>
            <div class="rbm-modal-body">
                <div class="rbm-form-group">
                    <label class="rbm-form-label">Tenant Code *</label>
                    <input type="text" class="rbm-form-input" @bind="editingTenant.TenantCode" 
                           disabled="@(editingTenant.Id > 0 || isSaving)" 
                           placeholder="e.g., TENANT001" maxlength="50" />
                    <small style="color: var(--rbm-text-light);">Unique identifier for the tenant (cannot be changed later)</small>
                </div>
                
                <div class="rbm-form-group">
                    <label class="rbm-form-label">Tenant Name *</label>
                    <input type="text" class="rbm-form-input" @bind="editingTenant.Name" 
                           disabled="@isSaving" placeholder="e.g., ABC Corporation" maxlength="200" />
                </div>
                
                <div class="rbm-form-group">
                    <label class="rbm-form-label">Description</label>
                    <textarea class="rbm-form-input" @bind="editingTenant.Description" 
                              rows="2" disabled="@isSaving" maxlength="500" placeholder="Brief description of the tenant"></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="rbm-form-group">
                        <label class="rbm-form-label">Contact Person</label>
                        <input type="text" class="rbm-form-input" @bind="editingTenant.ContactPerson" 
                               disabled="@isSaving" maxlength="100" />
                    </div>
                    <div class="rbm-form-group">
                        <label class="rbm-form-label">Contact Email</label>
                        <input type="email" class="rbm-form-input" @bind="editingTenant.ContactEmail" 
                               disabled="@isSaving" maxlength="100" />
                    </div>
                </div>
                
                <div class="rbm-form-group">
                    <label class="rbm-form-label">Contact Phone</label>
                    <input type="tel" class="rbm-form-input" @bind="editingTenant.ContactPhone" 
                           disabled="@isSaving" maxlength="20" />
                </div>
                
                <h4 style="margin: 24px 0 16px 0; padding-bottom: 8px; border-bottom: 1px solid var(--rbm-border);">
                    📊 Resource Limits
                </h4>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                    <div class="rbm-form-group">
                        <label class="rbm-form-label">Max Users *</label>
                        <input type="number" class="rbm-form-input" @bind="editingTenant.MaxUsers" 
                               min="1" disabled="@isSaving" />
                    </div>
                    <div class="rbm-form-group">
                        <label class="rbm-form-label">Max Assets *</label>
                        <input type="number" class="rbm-form-input" @bind="editingTenant.MaxAssets" 
                               min="1" disabled="@isSaving" />
                    </div>
                    <div class="rbm-form-group">
                        <label class="rbm-form-label">Max Documents *</label>
                        <input type="number" class="rbm-form-input" @bind="editingTenant.MaxDocuments" 
                               min="1" disabled="@isSaving" />
                    </div>
                </div>
            </div>
            <div class="rbm-modal-footer">
                <button class="rbm-btn rbm-btn-secondary" @onclick="CloseTenantModal" disabled="@isSaving">Cancel</button>
                <button class="rbm-btn rbm-btn-primary" @onclick="SaveTenant" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span>⏳ Saving...</span>
                    }
                    else
                    {
                        <span>💾 Save Tenant</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

<!-- Confirmation Modal -->
@if (showConfirmationModal)
{
    <div class="rbm-modal-overlay" @onclick="CancelConfirmation">
        <div class="rbm-modal" @onclick:stopPropagation="true" style="max-width: 400px;">
            <div class="rbm-modal-header">
                <h3>⚠️ Confirm Action</h3>
                <button class="rbm-modal-close" @onclick="CancelConfirmation" disabled="@isSaving">✕</button>
            </div>
            <div class="rbm-modal-body">
                <p>@confirmationMessage</p>
            </div>
            <div class="rbm-modal-footer">
                <button class="rbm-btn rbm-btn-secondary" @onclick="CancelConfirmation" disabled="@isSaving">Cancel</button>
                <button class="rbm-btn @(confirmationType == "delete" ? "rbm-btn-danger" : "rbm-btn-warning")" 
                        @onclick="ExecuteConfirmedAction" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span>⏳ Processing...</span>
                    }
                    else
                    {
                        <span>@(confirmationType == "delete" ? "🗑️ Delete" : "⏸️ Deactivate")</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<Tenant> tenants = new();
    private Tenant? editingTenant;
    private bool showTenantModal = false;
    private bool showConfirmationModal = false;
    private bool isLoading = true;
    private bool isSaving = false;
    private string? errorMessage;
    private string? successMessage;
    private int? confirmationTenantId;
    private string confirmationType = "delete";
    private string confirmationMessage = "";

    protected override async Task OnInitializedAsync()
    {
        // Verify SuperAdmin access
        var isSuperAdmin = await RolePermissionService.IsSuperAdminAsync();
        if (!isSuperAdmin)
        {
            NavigationManager.NavigateTo("/access-denied");
            return;
        }

        await LoadTenants();
    }

    private async Task LoadTenants()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            tenants = await TenantManagementService.GetAllTenantsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load tenants: {ex.GetBaseException().Message}";
            Console.WriteLine($"ERROR loading tenants: {ex}");
            tenants = new();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OpenCreateTenantModal()
    {
        editingTenant = new Tenant
        {
            MaxUsers = 10,
            MaxAssets = 100,
            MaxDocuments = 500,
            IsActive = true,
            Status = "Active"
        };
        showTenantModal = true;
    }

    private void OpenEditTenantModal(Tenant tenant)
    {
        editingTenant = new Tenant
        {
            Id = tenant.Id,
            TenantCode = tenant.TenantCode,
            Name = tenant.Name,
            Description = tenant.Description,
            ContactPerson = tenant.ContactPerson,
            ContactEmail = tenant.ContactEmail,
            ContactPhone = tenant.ContactPhone,
            Address = tenant.Address,
            City = tenant.City,
            Country = tenant.Country,
            PostalCode = tenant.PostalCode,
            MaxUsers = tenant.MaxUsers,
            MaxAssets = tenant.MaxAssets,
            MaxDocuments = tenant.MaxDocuments,
            IsActive = tenant.IsActive,
            Status = tenant.Status,
            Users = tenant.Users
        };
        showTenantModal = true;
    }

    private void CloseTenantModal()
    {
        showTenantModal = false;
        editingTenant = null;
        errorMessage = null;
    }

    private void ManageTenantUsers(int tenantId)
    {
        NavigationManager.NavigateTo($"/rbm/tenant-users/{tenantId}");
    }

    private async Task SaveTenant()
    {
        if (editingTenant == null)
        {
            errorMessage = "Invalid tenant data";
            return;
        }

        if (string.IsNullOrWhiteSpace(editingTenant.TenantCode))
        {
            errorMessage = "Tenant Code is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(editingTenant.Name))
        {
            errorMessage = "Tenant Name is required";
            return;
        }

        if (editingTenant.MaxUsers <= 0 || editingTenant.MaxAssets <= 0 || editingTenant.MaxDocuments <= 0)
        {
            errorMessage = "Resource limits must be greater than 0";
            return;
        }

        isSaving = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            var trimmedCode = editingTenant.TenantCode.Trim();
            var trimmedName = editingTenant.Name.Trim();
            var createdBy = "SuperAdmin";

            if (editingTenant.Id == 0)
            {
                // Create new tenant
                var result = await TenantManagementService.CreateTenantAsync(trimmedCode, trimmedName, createdBy);

                if (result == null)
                {
                    errorMessage = "Failed to create tenant. The tenant code may already exist.";
                    return;
                }

                // Update with additional fields
                result.Description = editingTenant.Description;
                result.ContactPerson = editingTenant.ContactPerson;
                result.ContactEmail = editingTenant.ContactEmail;
                result.ContactPhone = editingTenant.ContactPhone;
                result.MaxUsers = editingTenant.MaxUsers;
                result.MaxAssets = editingTenant.MaxAssets;
                result.MaxDocuments = editingTenant.MaxDocuments;
                
                await TenantManagementService.UpdateTenantAsync(result, createdBy);

                successMessage = $"Tenant '{trimmedName}' created successfully!";
            }
            else
            {
                // Update existing tenant
                var success = await TenantManagementService.UpdateTenantAsync(editingTenant, createdBy);

                if (!success)
                {
                    errorMessage = "Failed to update tenant. Please try again.";
                    return;
                }

                successMessage = $"Tenant '{trimmedName}' updated successfully!";
            }

            CloseTenantModal();
            await LoadTenants();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving tenant: {ex.GetBaseException().Message}";
            Console.WriteLine($"ERROR saving tenant: {ex}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ConfirmDeleteTenant(int tenantId, string tenantName)
    {
        confirmationType = "delete";
        confirmationTenantId = tenantId;
        confirmationMessage = $"Are you sure you want to delete the tenant '{tenantName}'? This action cannot be undone and will remove all associated data.";
        showConfirmationModal = true;
    }

    private void ConfirmDeactivateTenant(int tenantId, string tenantName)
    {
        confirmationType = "deactivate";
        confirmationTenantId = tenantId;
        confirmationMessage = $"Are you sure you want to deactivate the tenant '{tenantName}'? Users will not be able to access the system.";
        showConfirmationModal = true;
    }

    private void CancelConfirmation()
    {
        showConfirmationModal = false;
        confirmationTenantId = null;
    }

    private async Task ExecuteConfirmedAction()
    {
        if (!confirmationTenantId.HasValue)
            return;

        isSaving = true;
        try
        {
            if (confirmationType == "delete")
            {
                await DeleteTenant(confirmationTenantId.Value);
            }
            else if (confirmationType == "deactivate")
            {
                await DeactivateTenant(confirmationTenantId.Value);
            }
        }
        finally
        {
            isSaving = false;
            CancelConfirmation();
        }
    }

    private async Task DeleteTenant(int tenantId)
    {
        try
        {
            var success = await TenantManagementService.DeleteTenantAsync(tenantId);

            if (success)
            {
                successMessage = "Tenant deleted successfully!";
                await LoadTenants();
            }
            else
            {
                errorMessage = "Failed to delete tenant.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting tenant: {ex.GetBaseException().Message}";
            Console.WriteLine($"ERROR deleting tenant: {ex}");
        }
    }

    private async Task ActivateTenant(int tenantId)
    {
        isSaving = true;
        try
        {
            var success = await TenantManagementService.ActivateTenantAsync(tenantId);
            
            if (success)
            {
                successMessage = "Tenant activated successfully!";
                await LoadTenants();
            }
            else
            {
                errorMessage = "Failed to activate tenant.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error activating tenant: {ex.GetBaseException().Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeactivateTenant(int tenantId)
    {
        try
        {
            var success = await TenantManagementService.DeactivateTenantAsync(tenantId);

            if (success)
            {
                successMessage = "Tenant deactivated successfully!";
                await LoadTenants();
            }
            else
            {
                errorMessage = "Failed to deactivate tenant.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deactivating tenant: {ex.GetBaseException().Message}";
        }
    }
}

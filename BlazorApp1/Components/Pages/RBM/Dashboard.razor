@page "/rbm"
@rendermode InteractiveServer
@layout RBMLayout
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject BlazorApp1.Services.DataService DataService
@inject BlazorApp1.Services.CurrentUserService CurrentUser
@inject NavigationManager Navigation
@using BlazorApp1.Models
@using BlazorApp1.Components.Shared

<PageTitle>Dashboard | RBM CMMS</PageTitle>

@if (!isInitialized)
{
    <div class="loading-container">
        <div class="loading-spinner"></div>
        <p>Loading dashboard...</p>
    </div>
}
else if (!string.IsNullOrEmpty(loadError))
{
    <div class="rbm-alert rbm-alert-danger" style="margin: 20px;">
        <span>⚠️</span>
        <div>
            <strong>Error Loading Dashboard</strong>
            <p style="margin: 8px 0 0 0;">@loadError</p>
        </div>
        <button class="rbm-btn rbm-btn-sm rbm-btn-outline" @onclick="RefreshDashboard" style="margin-left: auto;">
            🔄 Retry
        </button>
    </div>
}
else
{
    <!-- Page Header with Welcome Message -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="welcome-section">
                <h1 class="dashboard-title">👋 Welcome back, @CurrentUser.UserName!</h1>
                <p class="dashboard-subtitle">Here's what's happening with your maintenance operations today.</p>
            </div>
            <div class="header-actions">
                <span class="last-updated">
                    <span class="update-icon">🔄</span>
                    Last updated: @DateTime.Now.ToString("MMM dd, HH:mm")
                </span>
                <button class="rbm-btn rbm-btn-outline rbm-btn-sm" @onclick="RefreshDashboard">
                    ↻ Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Alert Banner (if any critical issues) -->
    @if (criticalAlerts.Any())
    {
        <div class="alert-banner">
            <div class="alert-icon">⚠️</div>
            <div class="alert-content">
                <strong>Attention Required:</strong>
                @criticalAlerts.First()
            </div>
            <button class="alert-close" @onclick="DismissAlert">×</button>
        </div>
    }

    <!-- KPI Cards Grid -->
    <div class="kpi-grid">
        <div class="kpi-card primary">
            <div class="kpi-icon">
                <span>⚙️</span>
            </div>
            <div class="kpi-content">
                <div class="kpi-value">@totalAssets</div>
                <div class="kpi-label">Total Assets</div>
                <div class="kpi-detail">
                    <span class="kpi-status healthy">@healthyCount healthy</span>
                    <span class="kpi-status critical">@criticalCount critical</span>
                </div>
            </div>
            <a href="/rbm/assets" class="kpi-link">View All →</a>
        </div>

        <div class="kpi-card success">
            <div class="kpi-icon">
                <span>📊</span>
            </div>
            <div class="kpi-content">
                <div class="kpi-value">@averageHealthScore.ToString("F0")%</div>
                <div class="kpi-label">Avg. Health Score</div>
                <div class="kpi-trend @(healthTrend >= 0 ? "positive" : "negative")">
                    @(healthTrend >= 0 ? "↑" : "↓") @Math.Abs(healthTrend).ToString("F1")% from last month
                </div>
            </div>
        </div>

        <div class="kpi-card warning">
            <div class="kpi-icon">
                <span>📋</span>
            </div>
            <div class="kpi-content">
                <div class="kpi-value">@openWorkOrders</div>
                <div class="kpi-label">Open Work Orders</div>
                <div class="kpi-detail">
                    <span class="kpi-status critical">@criticalWorkOrders critical</span>
                    <span class="kpi-status warning">@overdueWorkOrders overdue</span>
                </div>
            </div>
            <a href="/rbm/work-orders" class="kpi-link">View All →</a>
        </div>

        <div class="kpi-card info">
            <div class="kpi-icon">
                <span>📦</span>
            </div>
            <div class="kpi-content">
                <div class="kpi-value">@lowStockParts</div>
                <div class="kpi-label">Low Stock Parts</div>
                <div class="kpi-detail">
                    Total Value: @totalInventoryValue.ToString("C0")
                </div>
            </div>
            <a href="/rbm/spare-parts" class="kpi-link">View All →</a>
        </div>
    </div>

    <!-- Reliability Metrics Row -->
    <div class="metrics-row">
        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-icon">⏱️</span>
                <span class="metric-title">MTBF</span>
                <span class="metric-tooltip" title="Mean Time Between Failures">ℹ️</span>
            </div>
            <div class="metric-value">@mtbf.ToString("N0")</div>
            <div class="metric-unit">Hours</div>
            <div class="metric-bar">
                <div class="metric-progress" style="width: @Math.Min(100, mtbf / 20).ToString("F0")%;"></div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-icon">🔧</span>
                <span class="metric-title">MTTR</span>
                <span class="metric-tooltip" title="Mean Time To Repair">ℹ️</span>
            </div>
            <div class="metric-value">@mttr.ToString("F1")</div>
            <div class="metric-unit">Hours</div>
            <div class="metric-bar warning">
                <div class="metric-progress" style="width: @Math.Min(100, mttr * 10).ToString("F0")%;"></div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-icon">✅</span>
                <span class="metric-title">OEE</span>
                <span class="metric-tooltip" title="Overall Equipment Effectiveness">ℹ️</span>
            </div>
            <div class="metric-value">@oee.ToString("F1")%</div>
            <div class="metric-unit">Effectiveness</div>
            <div class="metric-bar success">
                <div class="metric-progress" style="width: @oee.ToString("F0")%;"></div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-icon">📈</span>
                <span class="metric-title">Availability</span>
                <span class="metric-tooltip" title="Asset Availability Rate">ℵ</span>
            </div>
            <div class="metric-value">@availability.ToString("F1")%</div>
            <div class="metric-unit">Uptime</div>
            <div class="metric-bar success">
                <div class="metric-progress" style="width: @availability.ToString("F0")%;"></div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <span class="metric-icon">🎯</span>
                <span class="metric-title">PM Compliance</span>
                <span class="metric-tooltip" title="Preventive Maintenance Compliance">ℵ</span>
            </div>
            <div class="metric-value">@pmCompliance.ToString("F0")%</div>
            <div class="metric-unit">On Schedule</div>
            <div class="metric-bar @(pmCompliance >= 90 ? "success" : pmCompliance >= 70 ? "warning" : "danger")">
                <div class="metric-progress" style="width: @pmCompliance.ToString("F0")%;"></div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="dashboard-grid">
        <!-- Asset Health Chart -->
        <div class="dashboard-card chart-card">
            <div class="card-header">
                <h3><span class="header-icon">🥧</span> Asset Health Distribution</h3>
            </div>
            <div class="card-body">
                <SimplePieChart HealthyCount="@healthyCount" 
                              WarningCount="@warningCount" 
                              CriticalCount="@criticalCount" />
            </div>
        </div>

        <!-- Critical Assets List -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3><span class="header-icon">🚨</span> Assets Requiring Attention</h3>
                <a href="/rbm/assets" class="header-link">View All</a>
            </div>
            <div class="card-body">
                @if (criticalAssets.Any())
                {
                    <div class="asset-list">
                        @foreach (var asset in criticalAssets)
                        {
                            <div class="asset-item @(asset.Status.ToLower())">
                                <div class="asset-info">
                                    <div class="asset-name">@asset.Name</div>
                                    <div class="asset-id">@asset.AssetId • @asset.Location</div>
                                </div>
                                <div class="asset-health">
                                    <div class="health-score @GetHealthClass(asset.HealthScore)">
                                        @asset.HealthScore%
                                    </div>
                                    <div class="health-label">Health</div>
                                </div>
                                <div class="asset-status">
                                    <span class="status-badge @asset.Status.ToLower()">@asset.Status</span>
                                </div>
                                <a href="/rbm/assets/@asset.Id" class="asset-action">→</a>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <span class="empty-icon">✅</span>
                        <p>All assets are in good health!</p>
                    </div>
                }
            </div>
        </div>

        <!-- Upcoming Work Orders -->
        <div class="dashboard-card wide-card">
            <div class="card-header">
                <h3><span class="header-icon">📅</span> Upcoming Maintenance</h3>
                <div class="header-tabs">
                    <button class="tab-btn @(workOrderFilter == "all" ? "active" : "")" @onclick='() => workOrderFilter = "all"'>All</button>
                    <button class="tab-btn @(workOrderFilter == "critical" ? "active" : "")" @onclick='() => workOrderFilter = "critical"'>Critical</button>
                    <button class="tab-btn @(workOrderFilter == "overdue" ? "active" : "")" @onclick='() => workOrderFilter = "overdue"'>Overdue</button>
                </div>
            </div>
            <div class="card-body">
                @if (GetFilteredWorkOrders().Any())
                {
                    <div class="work-order-table">
                        <div class="table-header">
                            <span class="col-wo">Work Order</span>
                            <span class="col-asset">Asset</span>
                            <span class="col-type">Type</span>
                            <span class="col-priority">Priority</span>
                            <span class="col-due">Due Date</span>
                            <span class="col-assigned">Assigned</span>
                            <span class="col-status">Status</span>
                        </div>
                        @foreach (var wo in GetFilteredWorkOrders().Take(7))
                        {
                            <div class="table-row @(wo.DueDate < DateTime.Now && wo.Status != "Completed" ? "overdue" : "")">
                                <span class="col-wo">
                                    <strong>@wo.WorkOrderId</strong>
                                </span>
                                <span class="col-asset">@wo.AssetName</span>
                                <span class="col-type">
                                    <span class="type-badge @wo.Type.ToLower().Replace(" ", "-")">@wo.Type</span>
                                </span>
                                <span class="col-priority">
                                    <span class="priority-badge @wo.Priority.ToLower()">@wo.Priority</span>
                                </span>
                                <span class="col-due @(wo.DueDate.HasValue && wo.DueDate < DateTime.Now && wo.Status != "Completed" ? "overdue-text" : "")">
                                    @(wo.DueDate?.ToString("MMM dd") ?? "Not set")
                                    @if (wo.DueDate.HasValue && wo.DueDate < DateTime.Now && wo.Status != "Completed")
                                    {
                                        <span class="overdue-badge">Overdue</span>
                                    }
                                </span>
                                <span class="col-assigned">@wo.AssignedTo</span>
                                <span class="col-status">
                                    <span class="status-pill @wo.Status.ToLower().Replace(" ", "-")">@wo.Status</span>
                                </span>
                            </div>
                        }
                    </div>
                    <div class="card-footer">
                        <a href="/rbm/work-orders" class="footer-link">View All @openWorkOrders Open Work Orders →</a>
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <span class="empty-icon">🎉</span>
                        <p>No pending work orders!</p>
                    </div>
                }
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3><span class="header-icon">📜</span> Recent Activity</h3>
            </div>
            <div class="card-body">
                <div class="activity-feed">
                    @foreach (var activity in recentActivities.Take(8))
                    {
                        <div class="activity-item">
                            <span class="activity-icon @activity.Type.ToLower()">@GetActivityIcon(activity.Type)</span>
                            <div class="activity-content">
                                <div class="activity-text">@activity.Description</div>
                                <div class="activity-time">@GetTimeAgo(activity.Timestamp)</div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3><span class="header-icon">⚡</span> Quick Actions</h3>
            </div>
            <div class="card-body">
                <div class="quick-actions-grid">
                    <a href="/rbm/work-orders" class="quick-action-btn" @onclick="ShowNewWorkOrderModal">
                        <span class="action-icon">📝</span>
                        <span class="action-label">New Work Order</span>
                    </a>
                    <a href="/rbm/assets" class="quick-action-btn">
                        <span class="action-icon">➕</span>
                        <span class="action-label">Add Asset</span>
                    </a>
                    <a href="/rbm/condition-monitoring" class="quick-action-btn">
                        <span class="action-icon">📈</span>
                        <span class="action-label">Log Reading</span>
                    </a>
                    <a href="/rbm/spare-parts" class="quick-action-btn">
                        <span class="action-icon">📦</span>
                        <span class="action-label">Issue Parts</span>
                    </a>
                    <a href="/rbm/documents" class="quick-action-btn">
                        <span class="action-icon">📄</span>
                        <span class="action-label">Upload Doc</span>
                    </a>
                    <a href="/rbm/analytics" class="quick-action-btn">
                        <span class="action-icon">📊</span>
                        <span class="action-label">View Reports</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Documents Needing Attention -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3><span class="header-icon">📄</span> Documents Status</h3>
                <a href="/rbm/documents" class="header-link">View All</a>
            </div>
            <div class="card-body">
                <div class="doc-stats">
                    <div class="doc-stat">
                        <div class="doc-stat-value">@totalDocuments</div>
                        <div class="doc-stat-label">Total Documents</div>
                    </div>
                    <div class="doc-stat warning">
                        <div class="doc-stat-value">@expiredDocuments</div>
                        <div class="doc-stat-label">Expired</div>
                    </div>
                    <div class="doc-stat info">
                        <div class="doc-stat-value">@reviewDocuments</div>
                        <div class="doc-stat-label">Need Review</div>
                    </div>
                </div>
                @if (expiredDocuments > 0 || reviewDocuments > 0)
                {
                    <div class="doc-alert">
                        <span class="doc-alert-icon">⚠️</span>
                        <span>@(expiredDocuments + reviewDocuments) documents require attention</span>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Footer Stats -->
    <div class="dashboard-footer">
        <div class="footer-stat">
            <span class="footer-label">Work Orders Completed This Month:</span>
            <span class="footer-value">@completedThisMonth</span>
        </div>
        <div class="footer-stat">
            <span class="footer-label">Total Downtime:</span>
            <span class="footer-value">@totalDowntimeHours.ToString("F0") hrs</span>
        </div>
        <div class="footer-stat">
            <span class="footer-label">Maintenance Cost (MTD):</span>
            <span class="footer-value">@maintenanceCostMTD.ToString("C0")</span>
        </div>
    </div>
}

<style>
    /* Loading State */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 400px;
        color: var(--rbm-text-light);
    }

    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid #e0e0e0;
        border-top-color: var(--rbm-accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Dashboard Header */
    .dashboard-header {
        margin-bottom: 24px;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 16px;
    }

    .dashboard-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--rbm-text);
        margin: 0 0 8px 0;
    }

    .dashboard-subtitle {
        color: var(--rbm-text-light);
        margin: 0;
        font-size: 15px;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .last-updated {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--rbm-text-light);
    }

    /* Alert Banner */
    .alert-banner {
        display: flex;
        align-items: center;
        gap: 12px;
        background: linear-gradient(135deg, rgba(229, 57, 53, 0.1) 0%, rgba(229, 57, 53, 0.05) 100%);
        border: 1px solid rgba(229, 57, 53, 0.3);
        border-radius: 10px;
        padding: 14px 20px;
        margin-bottom: 24px;
    }

    .alert-icon {
        font-size: 24px;
    }

    .alert-content {
        flex: 1;
        font-size: 14px;
        color: #c62828;
    }

    .alert-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #c62828;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    /* KPI Cards */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 24px;
    }

    .kpi-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }

    .kpi-card.primary::before { background: linear-gradient(90deg, #0288d1, #03a9f4); }
    .kpi-card.success::before { background: linear-gradient(90deg, #43a047, #66bb6a); }
    .kpi-card.warning::before { background: linear-gradient(90deg, #fb8c00, #ffa726); }
    .kpi-card.info::before { background: linear-gradient(90deg, #7b1fa2, #ab47bc); }

    .kpi-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin-bottom: 16px;
        background: var(--rbm-bg);
    }

    .kpi-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--rbm-text);
        line-height: 1;
        margin-bottom: 4px;
    }

    .kpi-label {
        font-size: 14px;
        color: var(--rbm-text-light);
        margin-bottom: 12px;
    }

    .kpi-detail {
        display: flex;
        gap: 12px;
        font-size: 12px;
    }

    .kpi-status.healthy { color: #43a047; }
    .kpi-status.warning { color: #fb8c00; }
    .kpi-status.critical { color: #e53935; }

    .kpi-trend {
        font-size: 12px;
    }

    .kpi-trend.positive { color: #43a047; }
    .kpi-trend.negative { color: #e53935; }

    .kpi-link {
        position: absolute;
        bottom: 16px;
        right: 16px;
        font-size: 13px;
        color: var(--rbm-accent);
        text-decoration: none;
        font-weight: 500;
    }

    .kpi-link:hover {
        text-decoration: underline;
    }

    /* Metrics Row */
    .metrics-row {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }

    .metric-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .metric-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        margin-bottom: 12px;
    }

    .metric-icon {
        font-size: 18px;
    }

    .metric-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--rbm-text);
    }

    .metric-tooltip {
        font-size: 12px;
        cursor: help;
        opacity: 0.5;
    }

    .metric-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--rbm-text);
    }

    .metric-unit {
        font-size: 12px;
        color: var(--rbm-text-light);
        margin-bottom: 12px;
    }

    .metric-bar {
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        overflow: hidden;
    }

    .metric-progress {
        height: 100%;
        background: var(--rbm-accent);
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    .metric-bar.success .metric-progress { background: #43a047; }
    .metric-bar.warning .metric-progress { background: #fb8c00; }
    .metric-bar.danger .metric-progress { background: #e53935; }

    /* Dashboard Grid */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
        margin-bottom: 24px;
    }

    .dashboard-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }

    .dashboard-card.wide-card {
        grid-column: span 2;
    }

    .dashboard-card.chart-card {
        grid-column: span 1;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--rbm-border);
    }

    .card-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--rbm-text);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .header-icon {
        font-size: 18px;
    }

    .header-link {
        font-size: 13px;
        color: var(--rbm-accent);
        text-decoration: none;
    }

    .header-tabs {
        display: flex;
        gap: 4px;
    }

    .tab-btn {
        padding: 6px 12px;
        border: none;
        background: none;
        font-size: 13px;
        color: var(--rbm-text-light);
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .tab-btn:hover {
        background: var(--rbm-bg);
    }

    .tab-btn.active {
        background: var(--rbm-accent);
        color: white;
    }

    .card-body {
        padding: 24px;
    }

    .card-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--rbm-border);
        text-align: center;
    }

    .footer-link {
        color: var(--rbm-accent);
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
    }

    /* Asset List */
    .asset-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .asset-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 14px 16px;
        background: var(--rbm-bg);
        border-radius: 10px;
        border-left: 4px solid #43a047;
        transition: transform 0.2s;
    }

    .asset-item:hover {
        transform: translateX(4px);
    }

    .asset-item.warning { border-left-color: #fb8c00; }
    .asset-item.critical { border-left-color: #e53935; }

    .asset-info {
        flex: 1;
    }

    .asset-name {
        font-weight: 600;
        color: var(--rbm-text);
        margin-bottom: 2px;
    }

    .asset-id {
        font-size: 12px;
        color: var(--rbm-text-light);
    }

    .asset-health {
        text-align: center;
    }

    .health-score {
        font-size: 18px;
        font-weight: 700;
    }

    .health-score.healthy { color: #43a047; }
    .health-score.warning { color: #fb8c00; }
    .health-score.critical { color: #e53935; }

    .health-label {
        font-size: 11px;
        color: var(--rbm-text-light);
    }

    .status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-badge.healthy { background: rgba(67, 160, 71, 0.1); color: #43a047; }
    .status-badge.warning { background: rgba(251, 140, 0, 0.1); color: #fb8c00; }
    .status-badge.critical { background: rgba(229, 57, 53, 0.1); color: #e53935; }

    .asset-action {
        color: var(--rbm-text-light);
        text-decoration: none;
        font-size: 20px;
    }

    /* Work Order Table */
    .work-order-table {
        display: flex;
        flex-direction: column;
    }

    .table-header, .table-row {
        display: grid;
        grid-template-columns: 120px 1fr 100px 90px 100px 100px 100px;
        gap: 12px;
        padding: 12px 16px;
        align-items: center;
    }

    .table-header {
        font-size: 12px;
        font-weight: 600;
        color: var(--rbm-text-light);
        text-transform: uppercase;
        border-bottom: 1px solid var(--rbm-border);
    }

    .table-row {
        border-bottom: 1px solid #f0f0f0;
        font-size: 14px;
    }

    .table-row:last-child {
        border-bottom: none;
    }

    .table-row.overdue {
        background: rgba(229, 57, 53, 0.03);
    }

    .type-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
    }

    .type-badge.preventive { background: rgba(2, 136, 209, 0.1); color: #0288d1; }
    .type-badge.corrective { background: rgba(251, 140, 0, 0.1); color: #fb8c00; }
    .type-badge.predictive { background: rgba(156, 39, 176, 0.1); color: #9c27b0; }
    .type-badge.emergency { background: rgba(229, 57, 53, 0.1); color: #e53935; }

    .priority-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
    }

    .priority-badge.low { background: rgba(67, 160, 71, 0.1); color: #43a047; }
    .priority-badge.medium { background: rgba(2, 136, 209, 0.1); color: #0288d1; }
    .priority-badge.high { background: rgba(251, 140, 0, 0.1); color: #fb8c00; }
    .priority-badge.critical { background: rgba(229, 57, 53, 0.1); color: #e53935; }

    .overdue-text {
        color: #e53935;
    }

    .overdue-badge {
        display: inline-block;
        padding: 2px 6px;
        background: #e53935;
        color: white;
        border-radius: 4px;
        font-size: 10px;
        margin-left: 4px;
    }

    .status-pill {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
    }

    .status-pill.open { background: rgba(2, 136, 209, 0.1); color: #0288d1; }
    .status-pill.in-progress { background: rgba(251, 140, 0, 0.1); color: #fb8c00; }
    .status-pill.completed { background: rgba(67, 160, 71, 0.1); color: #43a047; }
    .status-pill.on-hold { background: rgba(158, 158, 158, 0.1); color: #9e9e9e; }

    /* Activity Feed */
    .activity-feed {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .activity-item {
        display: flex;
        gap: 12px;
    }

    .activity-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        flex-shrink: 0;
    }

    .activity-icon.workorder { background: rgba(2, 136, 209, 0.1); }
    .activity-icon.asset { background: rgba(67, 160, 71, 0.1); }
    .activity-icon.alert { background: rgba(229, 57, 53, 0.1); }
    .activity-icon.document { background: rgba(156, 39, 176, 0.1); }

    .activity-content {
        flex: 1;
    }

    .activity-text {
        font-size: 13px;
        color: var(--rbm-text);
        line-height: 1.4;
    }

    .activity-time {
        font-size: 11px;
        color: var(--rbm-text-light);
        margin-top: 2px;
    }

    /* Quick Actions */
    .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .quick-action-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 14px 16px;
        background: var(--rbm-bg);
        border-radius: 10px;
        text-decoration: none;
        color: var(--rbm-text);
        transition: all 0.2s;
    }

    .quick-action-btn:hover {
        background: var(--rbm-accent);
        color: white;
        transform: translateY(-2px);
    }

    .action-icon {
        font-size: 20px;
    }

    .action-label {
        font-size: 13px;
        font-weight: 500;
    }

    /* Documents Stats */
    .doc-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 16px;
    }

    .doc-stat {
        text-align: center;
        padding: 16px;
        background: var(--rbm-bg);
        border-radius: 10px;
    }

    .doc-stat.warning {
        background: rgba(251, 140, 0, 0.1);
    }

    .doc-stat.info {
        background: rgba(2, 136, 209, 0.1);
    }

    .doc-stat-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--rbm-text);
    }

    .doc-stat-label {
        font-size: 12px;
        color: var(--rbm-text-light);
    }

    .doc-alert {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px;
        background: rgba(251, 140, 0, 0.1);
        border-radius: 8px;
        font-size: 13px;
        color: #e65100;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 32px;
        color: var(--rbm-text-light);
    }

    .empty-icon {
        font-size: 40px;
        display: block;
        margin-bottom: 8px;
    }

    /* Dashboard Footer */
    .dashboard-footer {
        display: flex;
        justify-content: center;
        gap: 48px;
        padding: 24px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .footer-stat {
        text-align: center;
    }

    .footer-label {
        font-size: 13px;
        color: var(--rbm-text-light);
        display: block;
        margin-bottom: 4px;
    }

    .footer-value {
        font-size: 20px;
        font-weight: 700;
        color: var(--rbm-text);
    }

    /* Responsive */
    @@media (max-width: 1200px) {
        .kpi-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .metrics-row {
            grid-template-columns: repeat(3, 1fr);
        }

        .dashboard-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .dashboard-card.wide-card {
            grid-column: span 2;
        }
    }

    @@media (max-width: 768px) {
        .kpi-grid {
            grid-template-columns: 1fr;
        }

        .metrics-row {
            grid-template-columns: repeat(2, 1fr);
        }

        .dashboard-grid {
            grid-template-columns: 1fr;
        }

        .dashboard-card.wide-card {
            grid-column: span 1;
        }

        .table-header, .table-row {
            grid-template-columns: 1fr 1fr;
        }

        .col-asset, .col-type, .col-assigned {
            display: none;
        }

        .dashboard-footer {
            flex-direction: column;
            gap: 16px;
        }

        .header-content {
            flex-direction: column;
        }
    }
</style>

@code {
    private bool isInitialized = false;
    private string workOrderFilter = "all";
    private List<string> criticalAlerts = new();

    // KPI Data
    private int totalAssets = 0;
    private int healthyCount = 0;
    private int warningCount = 0;
    private int criticalCount = 0;
    private double averageHealthScore = 0;
    private double healthTrend = 0;
    private int openWorkOrders = 0;
    private int criticalWorkOrders = 0;
    private int overdueWorkOrders = 0;
    private int lowStockParts = 0;
    private decimal totalInventoryValue = 0;

    // Reliability Metrics
    private double mtbf = 0;
    private double mttr = 0;
    private double oee = 0;
    private double availability = 0;
    private double pmCompliance = 0;

    // Lists
    private List<Asset> assets = new();
    private List<Asset> criticalAssets = new();
    private List<WorkOrder> workOrders = new();
    private List<ActivityItem> recentActivities = new();

    // Document Stats
    private int totalDocuments = 0;
    private int expiredDocuments = 0;
    private int reviewDocuments = 0;

    // Footer Stats
    private int completedThisMonth = 0;
    private double totalDowntimeHours = 0;
    private decimal maintenanceCostMTD = 0;
    private string? loadError = null;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await CurrentUser.InitializeAsync();
            await LoadDashboardData();
        }
        catch (Exception ex)
        {
            loadError = $"Error initializing dashboard: {ex.Message}";
            Console.WriteLine($"Dashboard initialization error: {ex}");
        }
        finally
        {
            isInitialized = true;
        }
    }

    private async Task LoadDashboardData()
    {
        try
        {
            // Load assets
            assets = await DataService.GetAssetsAsync();
            totalAssets = assets.Count;
            healthyCount = assets.Count(a => a.Status == "Healthy" || a.HealthScore >= 80);
            warningCount = assets.Count(a => a.Status == "Warning" || (a.HealthScore >= 50 && a.HealthScore < 80));
            criticalCount = assets.Count(a => a.Status == "Critical" || a.HealthScore < 50);
            averageHealthScore = assets.Any() ? assets.Average(a => a.HealthScore) : 0;
            healthTrend = 3.2;

            criticalAssets = assets
                .Where(a => a.Status == "Critical" || a.Status == "Warning" || a.HealthScore < 80)
                .OrderBy(a => a.HealthScore)
                .Take(5)
                .ToList();

            // Load work orders
            workOrders = await DataService.GetWorkOrdersAsync();
            openWorkOrders = workOrders.Count(wo => wo.Status != "Completed");
            criticalWorkOrders = workOrders.Count(wo => wo.Priority == "Critical" && wo.Status != "Completed");
            overdueWorkOrders = workOrders.Count(wo => wo.DueDate < DateTime.Now && wo.Status != "Completed");
            completedThisMonth = workOrders.Count(wo => 
                wo.Status == "Completed" && 
                wo.CompletedDate.HasValue && 
                wo.CompletedDate.Value.Month == DateTime.Now.Month &&
                wo.CompletedDate.Value.Year == DateTime.Now.Year);

            // Use async methods to avoid deadlocks
            lowStockParts = await DataService.GetLowStockCountAsync();
            totalInventoryValue = await DataService.GetTotalInventoryValueAsync();

            totalDocuments = await DataService.GetTotalDocumentsAsync();
            expiredDocuments = await DataService.GetExpiredDocumentsCountAsync();
            reviewDocuments = await DataService.GetDocumentsNeedingReviewCountAsync();

            CalculateReliabilityMetrics();
            GenerateRecentActivities();
            CheckCriticalAlerts();
            
            loadError = null;
        }
        catch (Exception ex)
        {
            loadError = $"Error loading dashboard data: {ex.Message}";
            Console.WriteLine($"Error loading dashboard data: {ex}");
        }
    }

    private void CalculateReliabilityMetrics()
    {
        // Calculate MTBF (Mean Time Between Failures) from actual failure work orders
        var failureWorkOrders = workOrders
            .Where(wo => wo.Type == "Corrective" || wo.Type == "Emergency")
            .Where(wo => wo.CreatedDate >= DateTime.Now.AddMonths(-1))
            .ToList();
        
        if (failureWorkOrders.Any() && totalAssets > 0)
        {
            // Calculate total operating hours (30 days * 24 hours * number of assets)
            double totalOperatingHours = 30 * 24 * totalAssets;
            int numberOfFailures = failureWorkOrders.Count;
            mtbf = totalOperatingHours / numberOfFailures;
        }
        else
        {
            mtbf = 0;
        }
        
        // Calculate MTTR (Mean Time To Repair) from completed work orders
        var completedWOs = workOrders
            .Where(wo => wo.Status == "Completed" && wo.CompletedDate.HasValue)
            .ToList();
        
        if (completedWOs.Any())
        {
            mttr = completedWOs.Average(wo => (wo.CompletedDate!.Value - wo.CreatedDate).TotalHours);
        }
        else
        {
            mttr = 0;
        }

        // Calculate OEE (Overall Equipment Effectiveness)
        // OEE = Availability × Performance × Quality
        // For now, we'll use availability as a proxy since we don't have performance and quality data
        if (totalAssets > 0)
        {
            double assetAvailability = ((double)(healthyCount + warningCount) / totalAssets);
            oee = assetAvailability * 100; // Convert to percentage
        }
        else
        {
            oee = 0;
        }

        // Calculate Availability (percentage of time assets are operational)
        if (totalAssets > 0)
        {
            availability = ((double)(healthyCount + warningCount) / totalAssets * 100);
        }
        else
        {
            availability = 0;
        }

        // Calculate PM Compliance (percentage of preventive maintenance completed on time)
        var scheduledPMs = workOrders.Count(wo => wo.Type == "Preventive");
        var completedPMs = workOrders.Count(wo => wo.Type == "Preventive" && wo.Status == "Completed");
        
        if (scheduledPMs > 0)
        {
            pmCompliance = ((double)completedPMs / scheduledPMs * 100);
        }
        else
        {
            pmCompliance = 0;
        }

        // Calculate total downtime hours from critical and warning assets
        // Estimate: Critical assets = 8 hours downtime, Warning assets = 2 hours downtime per month
        totalDowntimeHours = (criticalCount * 8) + (warningCount * 2);

        // Calculate maintenance cost from completed work orders this month
        // Use actual cost if available, otherwise estimate based on work order count
        var costFromWorkOrders = completedThisMonth * 450m; // $450 average per work order
        var costFromParts = lowStockParts * 120m; // $120 average per low-stock part
        maintenanceCostMTD = costFromWorkOrders + costFromParts;
    }

    private void GenerateRecentActivities()
    {
        recentActivities = new List<ActivityItem>();

        foreach (var wo in workOrders.OrderByDescending(w => w.CreatedDate).Take(3))
        {
            recentActivities.Add(new ActivityItem
            {
                Type = "WorkOrder",
                Description = $"Work order {wo.WorkOrderId} ({wo.Type}) - {wo.Status}",
                Timestamp = wo.CreatedDate
            });
        }

        foreach (var asset in criticalAssets.Take(2))
        {
            recentActivities.Add(new ActivityItem
            {
                Type = "Asset",
                Description = $"{asset.Name} health score dropped to {asset.HealthScore}%",
                Timestamp = DateTime.Now.AddHours(-Random.Shared.Next(1, 48))
            });
        }

        if (criticalWorkOrders > 0)
        {
            recentActivities.Add(new ActivityItem
            {
                Type = "Alert",
                Description = $"{criticalWorkOrders} critical work orders require immediate attention",
                Timestamp = DateTime.Now.AddMinutes(-30)
            });
        }

        if (lowStockParts > 0)
        {
            recentActivities.Add(new ActivityItem
            {
                Type = "Alert",
                Description = $"{lowStockParts} spare parts are below reorder point",
                Timestamp = DateTime.Now.AddHours(-2)
            });
        }

        recentActivities = recentActivities.OrderByDescending(a => a.Timestamp).ToList();
    }

    private void CheckCriticalAlerts()
    {
        criticalAlerts.Clear();

        if (criticalCount > 0)
        {
            criticalAlerts.Add($"{criticalCount} assets are in critical condition and require immediate attention.");
        }
        else if (overdueWorkOrders > 0)
        {
            criticalAlerts.Add($"{overdueWorkOrders} work orders are overdue. Review and update schedules.");
        }
        else if (expiredDocuments > 0)
        {
            criticalAlerts.Add($"{expiredDocuments} documents have expired and need renewal.");
        }
    }

    private List<WorkOrder> GetFilteredWorkOrders()
    {
        return workOrderFilter switch
        {
            "critical" => workOrders.Where(wo => wo.Priority == "Critical" && wo.Status != "Completed").OrderBy(wo => wo.DueDate).ToList(),
            "overdue" => workOrders.Where(wo => wo.DueDate < DateTime.Now && wo.Status != "Completed").OrderBy(wo => wo.DueDate).ToList(),
            _ => workOrders.Where(wo => wo.Status != "Completed").OrderBy(wo => wo.DueDate).ToList()
        };
    }

    private async Task RefreshDashboard()
    {
        isInitialized = false;
        StateHasChanged();
        await LoadDashboardData();
        isInitialized = true;
        StateHasChanged();
    }

    private void DismissAlert()
    {
        if (criticalAlerts.Any())
        {
            criticalAlerts.RemoveAt(0);
        }
    }

    private void ShowNewWorkOrderModal()
    {
        Navigation.NavigateTo("/rbm/work-orders");
    }

    private string GetHealthClass(double score)
    {
        if (score >= 80) return "healthy";
        if (score >= 50) return "warning";
        return "critical";
    }

    private string GetActivityIcon(string type) => type switch
    {
        "WorkOrder" => "📋",
        "Asset" => "⚙️",
        "Alert" => "⚠️",
        "Document" => "📄",
        _ => "📝"
    };

    private string GetTimeAgo(DateTime timestamp)
    {
        var diff = DateTime.Now - timestamp;
        
        if (diff.TotalMinutes < 1) return "Just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}d ago";
        return timestamp.ToString("MMM dd");
    }

    private class ActivityItem
    {
        public string Type { get; set; } = "";
        public string Description { get; set; } = "";
        public DateTime Timestamp { get; set; }
    }
}

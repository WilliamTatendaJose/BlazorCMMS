# Azure Deployment Plan for RBM CMMS

## **Goal**
Deploy the RBM CMMS Blazor Server application to Azure Web App Service with Azure SQL Database.

## **Project Information**

| Property | Value |
|----------|-------|
| **Application Name** | RBM CMMS |
| **Technology Stack** | .NET 10 Blazor Server with ASP.NET Core Identity |
| **Database** | SQL Server (migrating to Azure SQL) |
| **Authentication** | ASP.NET Core Identity with role-based authorization |
| **External Services** | Twilio WhatsApp API, Azure OpenAI (optional) |

### Key Features
- Multi-tenant CMMS system
- Work order management
- Asset management
- WhatsApp integration with AI assistant
- Document management
- Spare parts inventory

## **Azure Resources Architecture**

```mermaid
graph TB
    subgraph "Azure Resource Group"
        subgraph "Compute"
            WA[Azure Web App<br/>B1/S1 Plan]
        end
        
        subgraph "Data"
            SQL[(Azure SQL Database<br/>Basic/S0)]
        end
        
        subgraph "Security"
            KV[Key Vault]
        end
        
        subgraph "Monitoring"
            AI[Application Insights]
            LA[Log Analytics]
        end
        
        subgraph "AI Services - Optional"
            AOAI[Azure OpenAI<br/>gpt-4o-mini]
        end
    end
    
    Users[Users/Technicians] --> WA
    WhatsApp[WhatsApp/Twilio] --> WA
    WA --> SQL
    WA --> KV
    WA --> AI
    WA -.-> AOAI
    AI --> LA
```

### Data Flow
1. Users access the web application via HTTPS
2. WhatsApp messages come through Twilio webhooks
3. Web App authenticates with managed identity
4. SQL Database stores all CMMS data
5. Key Vault secures connection strings and secrets
6. Application Insights monitors performance

## **Recommended Azure Resources**

### Primary Application
| Resource | Configuration |
|----------|--------------|
| **Azure Web App** | |
| SKU | B1 (Basic) - 1 Core, 1.75 GB RAM |
| Runtime | .NET 10 |
| OS | Linux (recommended) or Windows |
| Always On | Enabled |

### Database
| Resource | Configuration |
|----------|--------------|
| **Azure SQL Database** | |
| SKU | Basic (5 DTUs) or S0 (10 DTUs) |
| Max Size | 2 GB (Basic) / 250 GB (S0) |
| Backup | Geo-redundant |

### Supporting Services
| Resource | Purpose |
|----------|---------|
| **Application Insights** | Performance monitoring, logging |
| **Log Analytics Workspace** | Centralized logging |
| **Key Vault** | Secure secrets storage |

### Optional Services
| Resource | Purpose |
|----------|---------|
| **Azure OpenAI** | AI assistant for WhatsApp |
| **Azure Communication Services** | Alternative to Twilio |

## **Environment Variables Required**

```
# Database
ConnectionStrings__DefaultConnection=Server=tcp:{server}.database.windows.net;Database=RBM_CMMS;...

# Email (keep existing or use SendGrid)
Email__SmtpServer=smtp.sendgrid.net
Email__SmtpPort=587
Email__SmtpUsername=apikey
Email__SmtpPassword={SendGrid API Key}
Email__FromEmail=noreply@yourdomain.com

# WhatsApp (Twilio)
WhatsApp__Enabled=true
WhatsApp__UseLLM=true
WhatsApp__TwilioAccountSid={your-sid}
WhatsApp__TwilioAuthToken={your-token}
WhatsApp__FromNumber=+14155238886

# Azure OpenAI (Optional)
AzureOpenAI__Enabled=true
AzureOpenAI__Endpoint=https://{resource}.openai.azure.com
AzureOpenAI__ApiKey={your-key}
AzureOpenAI__DeploymentName=gpt-4o-mini
```

## **Deployment Options**

### Option 1: Azure Developer CLI (azd) - Recommended
Best for: Infrastructure as Code, repeatable deployments

### Option 2: Visual Studio Publish - Quick Start
Best for: Quick deployment, familiar workflow

### Option 3: GitHub Actions CI/CD
Best for: Automated deployments on code changes

---

## **Execution Steps**

### Pre-requisites
1. Install Azure CLI: https://docs.microsoft.com/cli/azure/install-azure-cli
2. Install Azure Developer CLI: https://learn.microsoft.com/azure/developer/azure-developer-cli/install-azd
3. Login to Azure:
   ```bash
   az login
   azd auth login
   ```

### Step 1: Create Azure Resources

```bash
# Set variables
$resourceGroup = "rg-rbm-cmms"
$location = "eastus"
$appName = "rbm-cmms-app"
$sqlServerName = "rbm-cmms-sql"
$sqlDbName = "RBM_CMMS"

# Create resource group
az group create --name $resourceGroup --location $location

# Create App Service Plan
az appservice plan create --name "$appName-plan" --resource-group $resourceGroup --sku B1 --is-linux

# Create Web App
az webapp create --resource-group $resourceGroup --plan "$appName-plan" --name $appName --runtime "DOTNETCORE:8.0"

# Create SQL Server
az sql server create --name $sqlServerName --resource-group $resourceGroup --location $location --admin-user sqladmin --admin-password "YourSecurePassword123!"

# Create SQL Database
az sql db create --resource-group $resourceGroup --server $sqlServerName --name $sqlDbName --service-objective Basic

# Allow Azure services
az sql server firewall-rule create --resource-group $resourceGroup --server $sqlServerName --name AllowAzure --start-ip-address 0.0.0.0 --end-ip-address 0.0.0.0
```

### Step 2: Configure App Settings

```bash
# Set connection string
az webapp config connection-string set --resource-group $resourceGroup --name $appName --connection-string-type SQLAzure --settings DefaultConnection="Server=tcp:$sqlServerName.database.windows.net,1433;Database=$sqlDbName;User ID=sqladmin;Password=YourSecurePassword123!;Encrypt=True;TrustServerCertificate=False;"

# Set app settings
az webapp config appsettings set --resource-group $resourceGroup --name $appName --settings \
    WhatsApp__Enabled=false \
    AzureOpenAI__Enabled=false
```

### Step 3: Deploy Application

#### Option A: From Visual Studio
1. Right-click on `BlazorApp1` project
2. Select "Publish"
3. Choose "Azure" ? "Azure App Service (Linux)"
4. Select your subscription and the app you created
5. Click "Publish"

#### Option B: From Command Line
```bash
cd BlazorApp1

# Publish
dotnet publish -c Release -o ./publish

# Deploy using Azure CLI
az webapp deploy --resource-group $resourceGroup --name $appName --src-path ./publish --type zip
```

#### Option C: GitHub Actions (see below)

### Step 4: Run Database Migrations

```bash
# Connect to Azure SQL and run migrations
# Option 1: Use SSMS or Azure Data Studio
# Option 2: Use EF Core migrations

dotnet ef database update --connection "Server=tcp:$sqlServerName.database.windows.net,1433;Database=$sqlDbName;..."
```

### Step 5: Verify Deployment

1. Open https://rbm-cmms-app.azurewebsites.net
2. Check Application Insights for errors
3. Test login functionality
4. Test WhatsApp webhook (if enabled)

---

## **GitHub Actions CI/CD Setup**

Create `.github/workflows/azure-deploy.yml`:

```yaml
name: Deploy to Azure Web App

on:
  push:
    branches: [ master ]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: rbm-cmms-app
  AZURE_WEBAPP_PACKAGE_PATH: './publish'
  DOTNET_VERSION: '10.0.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore BlazorApp1/BlazorApp1.csproj
    
    - name: Build
      run: dotnet build BlazorApp1/BlazorApp1.csproj --configuration Release --no-restore
    
    - name: Publish
      run: dotnet publish BlazorApp1/BlazorApp1.csproj -c Release -o ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
    
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
```

---

## **Cost Estimation**

| Resource | SKU | Estimated Monthly Cost |
|----------|-----|----------------------|
| App Service | B1 | ~$13/month |
| Azure SQL | Basic | ~$5/month |
| Application Insights | Free tier | $0 (up to 5GB) |
| **Total** | | **~$18-25/month** |

For production:
| Resource | SKU | Estimated Monthly Cost |
|----------|-----|----------------------|
| App Service | S1 | ~$70/month |
| Azure SQL | S0 | ~$15/month |
| Azure OpenAI | Pay-per-use | ~$5-20/month |
| **Total** | | **~$90-110/month** |

---

## **Post-Deployment Checklist**

- [ ] Verify web app is accessible
- [ ] Test user login/registration
- [ ] Verify database connection
- [ ] Test work order creation
- [ ] Configure custom domain (optional)
- [ ] Enable HTTPS only
- [ ] Set up backup schedule
- [ ] Configure WhatsApp webhook URL
- [ ] Test WhatsApp integration
- [ ] Set up monitoring alerts

---

## **Webhook Configuration for WhatsApp**

After deployment, update your Twilio WhatsApp settings:

**Webhook URL**: `https://rbm-cmms-app.azurewebsites.net/api/whatsappwebhook/incoming`

**Status Callback**: `https://rbm-cmms-app.azurewebsites.net/api/whatsappwebhook/status`

---

## **Quick Start Commands**

```bash
# 1. Login to Azure
az login

# 2. Create all resources at once
az deployment group create \
  --resource-group rg-rbm-cmms \
  --template-file infra/main.bicep

# 3. Deploy app
dotnet publish -c Release
az webapp deploy --resource-group rg-rbm-cmms --name rbm-cmms-app --src-path ./publish
```

---

**Next Steps**: Run `az login` to authenticate, then follow the execution steps above.
